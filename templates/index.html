<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TUM - Chair of Spacecraft Systems | AUTOPS - CoALA Architecture</title>
    <!-- Roboto Font (per TUM web) -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <!-- Cesium for 3D satellite visualization -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <!-- Satellite.js for TLE propagation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/5.0.0/satellite.min.js"></script>
    <style>
        :root {
            --tum-blue: #3070b3;
            --tum-dark: #03214a;
            --tum-grey: #e9ecef;
            --sidebar-width: 250px;
        }
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            width: var(--sidebar-width);
            background: var(--tum-dark);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .chair-info-sidebar {
            font-size: 12px;
            font-weight: 400;
            color: #dbeeef;
            line-height: 1.4;
            text-align: left;
        }
        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s ease;
            border-left: 3px solid transparent;
        }
        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }
        .nav-item.active {
            background: rgba(255,255,255,0.2);
            border-left-color: #fff;
        }
        .nav-item-icon {
            margin-right: 12px;
            font-size: 16px;
            width: 20px;
            text-align: center;
            font-weight: bold;
        }
        .nav-item-text {
            font-size: 14px;
            font-weight: 500;
        }
        .sidebar-footer {
            padding: 15px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .sidebar-footer .status-indicator {
            font-size: 12px;
        }
        .sidebar-footer #llm-status-sidebar {
            font-size: 12px;
            color: #b0bec5;
        }
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
        }
        .top-header {
            background: linear-gradient(to right, var(--tum-dark), var(--tum-blue));
            color: white;
            padding: 20px 30px;
            border-bottom: 1px solid var(--tum-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .tum-logo {
            display: flex;
            align-items: center;
        }
        .tum-logo img {
            height: 48px;
            width: auto;
            vertical-align: middle;
            max-width: 200px;
        }
        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin: 0;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 30px;
        }
        .header-logo img {
            height: 40px;
            width: auto;
            max-width: 120px;
        }
        .chair-info {
            font-size: 13px;
            font-weight: 400;
            text-align: right;
            color: #dbeeef;
            line-height: 1.3;
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00cc66;
        }
        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 120px);
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .section-header {
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--tum-dark);
            margin: 0 0 8px 0;
        }
        .section-subtitle {
            color: #666;
            font-size: 14px;
            margin: 0;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .dashboard-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid var(--tum-blue);
        }
        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--tum-dark);
            margin: 0 0 10px 0;
        }
        .card-content {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        .alerts-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .alert-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .alert-item:last-child {
            border-bottom: none;
        }
        .alert-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f39c12;
        }
        .alert-icon.high {
            background: #e74c3c;
        }
        .alert-icon.low {
            background: #27ae60;
        }
        .alert-content {
            flex: 1;
        }
        .alert-title {
            font-weight: 600;
            color: var(--tum-dark);
            margin: 0 0 4px 0;
        }
        .alert-description {
            color: #666;
            font-size: 14px;
            margin: 0;
        }
        .alert-time {
            color: #999;
            font-size: 12px;
        }
        .tasks-list {
            background: transparent;
            border-radius: 8px;
            overflow: visible;
        }
        .task-item {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 15px;
            border-radius: 8px;
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .task-item:last-child {
            border-bottom: 1px solid #e0e0e0;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-title {
            font-weight: 600;
            color: var(--tum-dark);
            margin: 0;
        }
        .task-progress {
            font-size: 14px;
            color: #666;
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background: var(--tum-blue);
            transition: width 0.3s ease;
        }
        .task-description {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .tool-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .tool-icon {
            font-size: 2rem;
            margin-bottom: 15px;
        }
        .tool-name {
            font-weight: 600;
            color: var(--tum-dark);
            margin: 0 0 8px 0;
        }
        .tool-description {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
            margin: 0 0 15px 0;
        }
        .tool-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .tool-status.available {
            background: #e8f5e8;
            color: #27ae60;
        }
        .tool-status.mock {
            background: #fff3cd;
            color: #856404;
        }
        
        /* History Section Styles */
        .history-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .history-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        .history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--tum-blue);
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 60vh;
            overflow-y: auto;
        }
        .history-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid var(--tum-blue);
        }
        .history-item.collision_assessment {
            border-left-color: #dc3545;
        }
        .history-item.autonomous_tasking {
            border-left-color: #28a745;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .history-title {
            font-weight: 600;
            color: var(--tum-dark);
            margin: 0;
        }
        .history-timestamp {
            color: #666;
            font-size: 14px;
        }
        .history-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .history-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #666;
        }
        .history-summary {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .history-actions {
            display: flex;
            gap: 10px;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn-view {
            background: var(--tum-blue);
            color: white;
        }
        .btn-view:hover {
            background: var(--tum-dark);
        }
        .confidence-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .confidence-high {
            background: #d4edda;
            color: #155724;
        }
        .confidence-medium {
            background: #fff3cd;
            color: #856404;
        }
        .confidence-low {
            background: #f8d7da;
            color: #721c24;
        }
        .loading-message {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }
        
        /* Tasks Section Styles */
        .tasks-container {
            display: flex;
            gap: 30px;
            min-height: 600px;
        }
        .tasks-column {
            flex: 1;
            min-width: 400px;
        }
        .tasks-column h3 {
            margin: 0 0 20px 0;
            color: var(--tum-dark);
            font-size: 1.1rem;
        }
        .task-button {
            background: var(--tum-blue);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background 0.3s ease;
        }
        .task-button:hover:not(:disabled) {
            background: var(--tum-dark);
        }
        .task-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .task-details-column {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .task-details-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        .task-details-header h3 {
            margin: 0 0 8px 0;
            color: var(--tum-dark);
        }
        .task-status {
            font-size: 14px;
            color: #666;
        }
        .reasoning-timeline {
            margin-bottom: 25px;
        }
        .reasoning-timeline h4 {
            margin: 0 0 15px 0;
            color: var(--tum-dark);
            font-size: 1rem;
        }
        .timeline-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid var(--tum-blue);
        }
        .timeline-item.reasoning {
            border-left-color: #3498db;
        }
        .timeline-item.tool-call {
            border-left-color: #e74c3c;
        }
        .timeline-item.completed {
            border-left-color: #27ae60;
        }
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .timeline-type {
            font-weight: 600;
            color: var(--tum-dark);
            font-size: 14px;
        }
        .timeline-time {
            font-size: 12px;
            color: #666;
        }
        .timeline-content {
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            overflow-x: auto;
            word-wrap: break-word;
            max-width: 100%;
        }
        .timeline-content details {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            max-width: 100%;
            overflow: hidden;
        }
        .timeline-content details summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--tum-blue);
            user-select: none;
        }
        .timeline-content details pre {
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-width: 100%;
        }
        .tool-call-code {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 8px 0;
            overflow-x: auto;
        }
        .task-results {
            margin-top: 25px;
        }
        .task-results h4 {
            margin: 0 0 15px 0;
            color: var(--tum-dark);
            font-size: 1rem;
        }
        .results-content {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #27ae60;
        }
        .results-content details.reasoning-log,
        .results-content details.messages-log {
            display: block;
            max-width: 100%;
            overflow: hidden;
            margin-top: 10px;
        }
        .results-content .model-message {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: anywhere;
            max-width: 100%;
            background: #fafafa;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
        }
        .result-item {
            margin-bottom: 10px;
        }
        .result-label {
            font-weight: 600;
            color: var(--tum-dark);
            margin-right: 8px;
        }
        .result-value {
            color: #333;
        }
        
        /* Mock/Real Indicators */
        .mock-indicator, .real-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
        }
        .mock-indicator {
            background: #fff3cd;
            color: #856404;
        }
        .real-indicator {
            background: #e8f5e8;
            color: #27ae60;
        }
        .mock-banner {
            background: #fff3cd;
            color: #856404;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            margin-top: 10px;
            border-left: 3px solid #ffc107;
        }
        .task-status-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin: 8px 0;
        }
        .task-status-indicator.real {
            background: #e8f5e8;
            color: #27ae60;
        }
        .task-status-indicator.mock {
            background: #fff3cd;
            color: #856404;
        }
        .tool-status.real {
            background: #e8f5e8;
            color: #27ae60;
        }
        
        /* Demo Notice */
        .demo-notice {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 30px;
        }
        .demo-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .demo-icon {
            font-size: 18px;
        }
        .demo-text {
            font-size: 14px;
            color: #1976d2;
            font-weight: 500;
        }
        
        /* Footer */
        .footer {
            background: var(--tum-dark);
            color: white;
            padding: 15px 30px;
            border-top: 1px solid var(--tum-blue);
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chair-info-footer {
            font-size: 10px;
            font-weight: 400;
            color: #dbeeef;
            line-height: 1.3;
        }
        .info-footer {
            font-size: 11px;
            color: #b0bec5;
            font-weight: 400;
            line-height: 1.4;
        }
        .info-footer .contact-label {
            font-size: 10px;
            color: #8a9ba8;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        .footer-right {
            font-size: 12px;
            color: #b0bec5;
            font-weight: 500;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            .main-content {
                margin-left: 200px;
            }
            .sidebar-logo img {
                height: 40px;
                max-width: 140px;
            }
            .content-area {
                padding: 20px;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .tools-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                width: 180px;
            }
            .main-content {
                margin-left: 180px;
            }
            .content-area {
                padding: 15px;
            }
            .top-header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
            }
            .header-left {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            .header-right {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            .header-title {
                font-size: 1.2rem;
            }
            .tum-logo img {
                height: 40px;
                max-width: 150px;
            }
            .chair-info {
                font-size: 11px;
            }
            .footer {
                padding: 12px 20px;
            }
            .footer-content {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            .chair-info-footer {
                font-size: 10px;
            }
            .footer-right {
                font-size: 11px;
            }
        }
        /* Satellite Visualization Panel */
        .viz-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .viz-header {
            padding: 15px 20px;
            background: linear-gradient(to right, var(--tum-dark), var(--tum-blue));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .viz-header h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .viz-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .viz-toggle:hover {
            background: rgba(255,255,255,0.3);
        }
        .viz-content {
            position: relative;
            height: 400px;
            display: none;
            transition: height 0.3s ease;
        }
        .viz-content.active {
            display: block;
        }
        .viz-content.expanded {
            height: 700px;
        }
        .viz-panel.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            margin: 0;
            border-radius: 0;
        }
        .viz-panel.fullscreen .viz-content {
            height: calc(100vh - 60px);
        }
        #cesiumContainer {
            width: 100%;
            height: 100%;
        }
        .viz-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            display: flex;
            gap: 8px;
        }
        .viz-btn {
            padding: 8px 12px;
            background: rgba(3, 33, 74, 0.9);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .viz-btn:hover {
            background: var(--tum-blue);
        }
        .viz-status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
        }
        .cesium-viewer-toolbar,
        .cesium-viewer-animationContainer,
        .cesium-viewer-timelineContainer,
        .cesium-viewer-bottom {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="chair-info-sidebar">
                Chair of Spacecraft Systems<br>
                    TUM School of Engineering and Design<br>
                Technical University of Munich
            </div>
        </div>
            <div class="nav-menu">
                <div class="nav-item active" data-section="tasks">
                    <div class="nav-item-icon">ü§ñ</div>
                    <div class="nav-item-text">AI Query Interface</div>
                </div>
                <div class="nav-item" data-section="satellites">
                    <div class="nav-item-icon">üõ∞Ô∏è</div>
                    <div class="nav-item-text">Satellite Tracker</div>
                </div>
                <div class="nav-item" data-section="info">
                    <div class="nav-item-icon">‚ÑπÔ∏è</div>
                    <div class="nav-item-text">System Information</div>
                </div>
            </div>
            
            <!-- Contact Information -->
            <div style="padding: 15px 20px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: #b0bec5;">
                <div style="margin-bottom: 10px;">
                    <div style="font-size: 10px; color: #8a9ba8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Contact</div>
                    <div style="line-height: 1.5;">
                        Clemente J. Juan Oliver<br>
                        <a href="mailto:clemente.juan@tum.de" style="color: #64b5f6; text-decoration: none;">clemente.juan@tum.de</a>
                    </div>
                </div>
                <div>
                    <div style="font-size: 10px; color: #8a9ba8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Repository</div>
                    <a href="https://github.com/clemenjuan/autops-demo" target="_blank" style="color: #64b5f6; text-decoration: none; display: inline-flex; align-items: center; gap: 5px;">
                        üíª View on GitHub
                    </a>
                </div>
            </div>
            
            <div class="sidebar-footer">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>System Online</span>
            </div>
                <div id="llm-status-sidebar">LLM: Checking...</div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <div class="top-header">
                <div class="header-left">
                    <h1 class="header-title">AUTOPS: Autonomous Satellite Operations Assistant <span style="font-size: 0.6em; color: #64b5f6; font-weight: normal;">(CoALA)</span></h1>
                </div>
                <div class="header-right">
                    <div class="header-logo">
                        <img src="/static/images/tum-logo-white.svg" alt="TUM">
                    </div>
                </div>
            </div>
            
            <!-- System Notice -->
            <div class="demo-notice">
                <div class="demo-content">
                    <span class="demo-text">
                        <strong>AI-Powered Tool Orchestration:</strong> Submit natural language queries. The system discovers and executes relevant tools dynamically.
                    </span>
            </div>
        </div>
        
            <div class="content-area">
                <!-- AI Query Interface -->
                <div class="content-section active" id="tasks">
                    <div class="section-header">
                        <h2 class="section-title">AI Query Interface</h2>
                    </div>
                    
                    <!-- Two-column layout for task details and reasoning -->
                    <div class="tasks-container">
                        <!-- Left column: Task list -->
                        <div class="tasks-column">
                            <div class="tasks-list">
                                <div class="task-item" data-task="query-submission">
                                    <div class="task-header">
                                        <h4 class="task-title">Submit Query</h4>
                                    </div>
                                    <p class="task-description">
                                        Submit a natural language query. The AI agent will analyze the task, discover relevant tools, and execute them dynamically.
                                    </p>
                                    <div>
                                        <label for="task-input" style="display:block;font-size:14px;color:#333;font-weight:500;margin-bottom:5px;">Query</label>
                                        <textarea id="task-input" style="width:calc(100% - 24px);padding:12px;margin-bottom:12px;border:1px solid #ddd;border-radius:4px;font-family:inherit;resize:vertical;box-sizing:border-box;" rows="3" placeholder="Example: Schedule satellite observation of Marienplatz in Munich">Schedule satellite observation of Marienplatz in Munich for tomorrow</textarea>
                                        
                                        <label for="additional-context-input" style="display:block;font-size:12px;color:#666;">Additional Context (optional)</label>
                                        <input id="additional-context-input" type="text" style="width:calc(100% - 24px);padding:8px;margin-bottom:12px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;" placeholder="Example: time window, sensor type, priority, etc." value="Optical imagery, high resolution, priority observation" />
                                    </div>
                                    <div class="task-status-indicator real">‚úÖ Active</div>
                                    <button class="task-button" onclick="submitQuery()">Submit Query</button>
                                </div>
        </div>
    </div>

                        <!-- Right column: Task details and reasoning timeline -->
                        <div class="task-details-column">
                            <div class="task-details-header">
                                <h3 id="selected-task-title">Select a task to view details</h3>
                                <div class="task-status" id="selected-task-status"></div>
                            </div>
            
                            <!-- Reasoning timeline -->
                            <div class="reasoning-timeline" id="reasoning-timeline" style="display: none;">
                                <h4>Events Timeline</h4>
                                <div class="timeline-items" id="timeline-items">
                                    <!-- Dynamic timeline items will be added here -->
            </div>
        </div>
        
                            <!-- Task results -->
                            <div class="task-results" id="task-results" style="display: none;">
                                <h4>Assessment Results</h4>
                                <div class="results-content" id="results-content">
                                    <!-- Dynamic results will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>
        </div>

                <!-- Satellite Tracker Section -->
                <div class="content-section" id="satellites">
                    <div class="section-header">
                        <h2 class="section-title">Live Satellite Tracker</h2>
                        <p class="section-subtitle">Real-time data for 30k+ satellites in orbit</p>
                    </div>

                    <!-- Controls -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; font-size: 14px; color: #333; font-weight: 500; margin-bottom: 5px;">Search by Constellation or Name</label>
                                <input type="text" id="sat-search" placeholder="e.g., STARLINK, ZARYA, GPS..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" />
                            </div>
                            <div style="flex: 0 0 150px;">
                                <label style="display: block; font-size: 14px; color: #333; font-weight: 500; margin-bottom: 5px;">Limit</label>
                                <select id="sat-limit" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="50">50</option>
                                    <option value="100" selected>100</option>
                                    <option value="500">500</option>
                                    <option value="1000">1,000</option>
                                    <option value="5000">5,000</option>
                                    <option value="10000">10,000</option>
                                    <option value="50000">All (50k max)</option>
                                </select>
                            </div>
                            <button onclick="loadSatellites()" style="padding: 10px 20px; background: var(--tum-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Load Satellites</button>
                            <button onclick="refreshSatelliteData()" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Refresh Data</button>
                        </div>
                        <div id="sat-status" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
                    </div>

                    <!-- 3D Visualization Panel -->
                    <div class="viz-panel">
                        <div class="viz-header" onclick="toggleVisualization()">
                            <h3>üåç Satellite Visualization</h3>
                            <button class="viz-toggle" id="viz-toggle-btn">Show Globe</button>
                        </div>
                        <div class="viz-content" id="viz-content">
                            <div id="cesiumContainer"></div>
                            <div class="viz-controls">
                                <button class="viz-btn" onclick="resetView()">üåç Reset View</button>
                                <button class="viz-btn" onclick="toggleOrbits()">‚≠ï Toggle Orbits</button>
                                <button class="viz-btn" onclick="toggleLabels()">üè∑Ô∏è Toggle Labels</button>
                                <button class="viz-btn" onclick="toggleVizSize()" id="viz-size-btn">‚õ∂ Expand</button>
                            </div>
                            <div class="viz-status" id="viz-status">Loading visualization...</div>
                        </div>
                    </div>

                    <!-- Satellite Statistics -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: var(--tum-blue);" id="total-sats">-</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">Total Satellites</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #4caf50;" id="leo-sats">-</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">LEO Satellites</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #ff9800;" id="meo-sats">-</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">MEO Satellites</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #f44336;" id="geo-sats">-</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">GEO Satellites</div>
                        </div>
                    </div>

                    <!-- Satellite List -->
                    <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; color: var(--tum-dark); font-size: 18px;">Satellite Database</h3>
                        <div id="sat-loading" style="text-align: center; padding: 40px; color: #666; display: none;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üõ∞Ô∏è</div>
                            <div>Loading satellite data...</div>
                        </div>
                        <div id="sat-table-container" style="overflow-x: auto;">
                            <table id="sat-table" style="width: 100%; border-collapse: collapse; display: none;">
                                <thead>
                                    <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">NORAD ID</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Name</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Country</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Operator</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Orbit</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Type</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="sat-table-body">
                                    <!-- Dynamic rows -->
                                </tbody>
                            </table>
                        </div>
                        <div id="sat-empty" style="text-align: center; padding: 40px; color: #999; display: none;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üîç</div>
                            <div>No satellites found. Click "Load Satellites" or start the API server.</div>
                        </div>
                    </div>

                    <!-- Satellite Details Modal -->
                    <div id="sat-details-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; padding: 20px; overflow-y: auto;">
                        <div style="max-width: 800px; margin: 40px auto; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            <div style="padding: 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                <h3 id="modal-sat-name" style="margin: 0; color: var(--tum-dark);">Satellite Details</h3>
                                <button onclick="closeSatelliteDetails()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
                            </div>
                            <div id="modal-sat-content" style="padding: 25px;">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Information Section -->
                <div class="content-section" id="info">
                    <div class="section-header">
                        <h2 class="section-title">System Information</h2>
                        <p class="section-subtitle">Architecture overview and implementation details</p>
                    </div>

                    <div style="display: grid; gap: 25px;">
                        <!-- Overview -->
                        <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px 0; color: var(--tum-dark); font-size: 18px;">What is AUTOPS?</h3>
                            <p style="margin: 0; line-height: 1.6; color: #333;">
                                AUTOPS (Autonomous Satellite Operations Assistant) is an AI-powered system built on the <strong>CoALA (Cognitive Architectures for Language Agents)</strong> framework. 
                                It enables natural language interaction with satellite operations tools using a dual LLM architecture, structured memory modules, and Planning <-> Execution reasoning cycles.
                            </p>
                        </div>

                        <!-- Architecture Diagram -->
                        <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px 0; color: var(--tum-dark); font-size: 18px;">Architecture</h3>
                            <p style="margin: 0 0 15px 0; font-size: 13px; color: #666;">
                                Based on <a href="https://arxiv.org/abs/2309.02427" target="_blank" style="color: var(--tum-blue);">Cognitive Architectures for Language Agents (CoALA)</a> [1] framework.
                            </p>
                            <div style="text-align: center; background: white; padding: 20px; border-radius: 6px;">
                                <img src="/static/images/AUTOPS-CoALA-architecture.png" alt="CoALA Architecture Diagram" style="max-width: 100%; height: auto; border-radius: 4px;">
                            </div>
                        </div>

                        <!-- Key Features -->
                        <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px 0; color: var(--tum-dark); font-size: 18px;">Key Features</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="padding: 15px; background: #e3f2fd; border-left: 4px solid var(--tum-blue); border-radius: 4px;">
                                    <h4 style="margin: 0 0 8px 0; color: var(--tum-blue); font-size: 14px;">Dual LLM Architecture</h4>
                                    <p style="margin: 0; font-size: 13px; line-height: 1.6;">General LLM (llama3.1:8b) for task preprocessing and keyword extraction. Reasoning LLM (deepseek-r1:70b) for complex planning and synthesis.</p>
                                </div>
                                <div style="padding: 15px; background: #f3e5f5; border-left: 4px solid #7b1fa2; border-radius: 4px;">
                                    <h4 style="margin: 0 0 8px 0; color: #7b1fa2; font-size: 14px;">Memory Modules</h4>
                                    <p style="margin: 0; font-size: 13px; line-height: 1.6;">Working, Episodic, Semantic, and Procedural memory for context-aware reasoning.</p>
                                </div>
                                <div style="padding: 15px; background: #e8f5e9; border-left: 4px solid #2e7d32; border-radius: 4px;">
                                    <h4 style="margin: 0 0 8px 0; color: #2e7d32; font-size: 14px;">Metadata-Driven Tools</h4>
                                    <p style="margin: 0; font-size: 13px; line-height: 1.6;">Tools defined in JSON/<a href="https://toonformat.dev/" target="_blank" style="color: var(--tum-blue);">TOON</a> [2] format, dynamically loaded and orchestrated by LLM.</p>
                                </div>
                                <div style="padding: 15px; background: #fff3e0; border-left: 4px solid #f57c00; border-radius: 4px;">
                                    <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 14px;">Planning‚ÜîExecution Cycles</h4>
                                    <p style="margin: 0; font-size: 13px; line-height: 1.6;">Iterative reasoning loop with memory retrieval, action planning, and result reflection.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer with Funding Information -->
            <div class="footer">
                <div class="footer-content" style="justify-content: center;">
                    <div style="text-align: center; font-size: 11px; color: #b0bec5;">
                        This work was supported by the AUTOPS project, within the Bavarian Joint Research Program of the StMWi (BayVFP), funding number MRF-2307-0004
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Navigation functionality
        function initNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const contentSections = document.querySelectorAll('.content-section');
            
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const targetSection = item.getAttribute('data-section');
                    
                    // Remove active class from all nav items
                    navItems.forEach(nav => nav.classList.remove('active'));
                    // Add active class to clicked item
                    item.classList.add('active');
                    
                    // Hide all content sections
                    contentSections.forEach(section => section.classList.remove('active'));
                    // Show target section
                    document.getElementById(targetSection).classList.add('active');
                });
            });
        }

        // System status checking
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (response.ok) {
                    const statusText = `LLM: ${data.llm_status}`;
                    // Update both status displays if they exist
                    const mainStatus = document.getElementById('llm-status');
                    const sidebarStatus = document.getElementById('llm-status-sidebar');
                    if (mainStatus) mainStatus.textContent = statusText;
                    if (sidebarStatus) sidebarStatus.textContent = statusText;
                } else {
                    const errorText = 'LLM: Error';
                    const mainStatus = document.getElementById('llm-status');
                    const sidebarStatus = document.getElementById('llm-status-sidebar');
                    if (mainStatus) mainStatus.textContent = errorText;
                    if (sidebarStatus) sidebarStatus.textContent = errorText;
                }
            } catch (error) {
                const offlineText = 'LLM: OpenAI API';
                const mainStatus = document.getElementById('llm-status');
                const sidebarStatus = document.getElementById('llm-status-sidebar');
                if (mainStatus) mainStatus.textContent = offlineText;
                if (sidebarStatus) sidebarStatus.textContent = offlineText;
            }
        }

        let currentTaskId = null;

        async function submitQuery() {
            currentTaskId = 'query-submission';
            
            // Update UI
            updateTaskDetails('Processing Query', 'In Progress');
            showReasoningTimeline();
            clearTimeline();
            
            // Clear previous results
            const container = document.getElementById('task-results');
            const content = document.getElementById('results-content');
            if (content) content.innerHTML = '';
            if (container) container.style.display = 'none';
            
            try {
                const query = (document.getElementById('task-input').value || '').trim();
                const additionalContext = (document.getElementById('additional-context-input').value || '').trim();
                
                if (!query) {
                    addTimelineItem('error', 'Validation Error', 'Please enter a query');
                    return;
                }
                addTimelineItem('reasoning', 'Submitting Query', `Query: ${query}`);
                
                const requestBody = { task: query };
                if (additionalContext) {
                    requestBody.additional_context = additionalContext;
                }
                
                // Use streaming endpoint for real-time updates
                const response = await fetch('/api/autonomous-tasking/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error('Query failed');
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let finalResult = null;
                let cycles = 0;
                
                while (true) {
                    const {done, value} = await reader.read();
                    
                    if (done) {
                        break;
                    }
                    
                    buffer += decoder.decode(value, {stream: true});
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6);
                            try {
                                const event = JSON.parse(jsonStr);
                                
                                if (event.type === 'phase') {
                                    // Real-time phase update
                                    const stepType = event.step.includes('TOOL') || event.step.includes('EXECUTE') ? 'tool-call' : 'reasoning';
                                    const confidence = event.confidence && !isNaN(event.confidence) ? ` [Confidence: ${(event.confidence * 100).toFixed(0)}%]` : '';
                                    
                                    addEnhancedTimelineItem(event, stepType, confidence);
                                    
                                } else if (event.type === 'complete') {
                                    finalResult = event.result;
                                    cycles = event.cycles || event.iterations;
                                    
                                } else if (event.type === 'error') {
                                    throw new Error(event.error);
                                }
                            } catch (e) {
                                console.error('Failed to parse SSE event:', e);
                            }
                        }
                    }
                }
                
                if (!finalResult) {
                    throw new Error('No result received from server');
                }
                
                const data = finalResult;
                
                // Check if user input is required
                if (data.user_input_required && data.user_prompts && data.user_prompts.length > 0) {
                    // Show user input required in timeline
                    addTimelineItem('error', 'üî¥ User Input Required', 
                        `System needs clarification: ${data.user_prompts.length} item(s) require attention`);
                } else {
                    // Show completion
                    addTimelineItem('completed', 'Query Complete', 
                        `Completed in ${cycles} cycle(s)`);
                }
                
                // Display results
                displayQueryResults(data);
                
                if (data.user_input_required) {
                    updateTaskDetails('‚ö†Ô∏è User Input Required', 'Awaiting Clarification');
                } else {
                    updateTaskDetails('Query Complete', 'Completed');
                }
                
                displayInResultsSection(data, 'query');
                
            } catch (error) {
                console.error('Query error:', error);
                addTimelineItem('error', 'Query Error', `Error: ${error.message}`);
                updateTaskDetails('Query', 'Error');
            }
        }
        
        function displayQueryResults(data) {
            const container = document.getElementById('task-results');
            const content = document.getElementById('results-content');
            
            // Check if user input is required
            if (data.user_input_required && data.user_prompts && data.user_prompts.length > 0) {
                displayUserInputRequest(data, content, container);
                return;
            }
            
            const result = data.result || data.situation_summary || '';
            const analysis = data.analysis || '';
            const recommendations = data.recommendations || [];
            const confidence = data.confidence || 0;
            
            content.innerHTML = `
                <div class="result-item"><span class="result-label">Query:</span> <span class="result-value">${data.query || data.task || ''}</span></div>
                <div class="result-item"><span class="result-label">Result:</span> <span class="result-value">${result}</span></div>
                <div class="result-item"><span class="result-label">Analysis:</span> <span class="result-value">${analysis}</span></div>
                <div class="result-item"><span class="result-label">Confidence:</span> <span class="result-value">${Math.round(confidence * 100)}%</span></div>
                ${recommendations.length > 0 ? `<div class="result-item"><span class="result-label">Recommendations:</span> <ul>${recommendations.map(r => `<li>${r}</li>`).join('')}</ul></div>` : ''}
            `;
            container.style.display = 'block';
        }
        
        function displayUserInputRequest(data, content, container) {
            
            const prompts = data.user_prompts.map((req, idx) => {
                const toolName = req.tool ? req.tool.split('_step_')[0] : 'Unknown Tool';
                return `
                    <div style="margin-bottom: 20px; padding: 20px; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 6px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">‚ö†Ô∏è</span>
                            <h4 style="margin: 0; color: #e65100; font-size: 16px;">Input Required: ${toolName}</h4>
                        </div>
                        <div style="margin-bottom: 15px; color: #666; font-size: 14px; line-height: 1.6;">
                            ${req.message}
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 4px; border: 1px solid #ffcc80;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 8px; font-size: 13px;">What information is needed:</div>
                            <div style="white-space: pre-wrap; color: #555; font-size: 13px; line-height: 1.8;">${req.prompt}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            content.innerHTML = `
                <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 25px; border-radius: 8px; border: 2px solid #ff9800; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div style="width: 50px; height: 50px; background: #ff9800; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px;">
                            üî¥
                        </div>
                        <div>
                            <h3 style="margin: 0; color: #e65100; font-size: 20px;">System Requires Additional Information</h3>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Please provide the missing details below to continue</p>
                        </div>
                    </div>
                </div>
                
                ${prompts}
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-top: 25px;">
                    <h4 style="margin: 0 0 12px 0; color: var(--tum-dark);">Provide Missing Information</h4>
                    <textarea id="user-clarification-input" 
                              style="width: calc(100% - 24px); min-height: 100px; padding: 12px; border: 2px solid #ff9800; border-radius: 4px; font-family: inherit; resize: vertical; font-size: 14px;"
                              placeholder="Enter the missing information here (e.g., 'Marienplatz' or coordinates [48.1374, 11.5755])"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 12px;">
                        <button onclick="resubmitWithClarification('${(data.query || data.task || '').replace(/'/g, "\\'")}', '${(data.additional_context || '').replace(/'/g, "\\'")}')" 
                                style="background: #ff9800; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600;">
                            ‚úì Submit Clarification
                        </button>
                        <button onclick="clearResults()" 
                                style="background: #bdc3c7; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            Cancel
                        </button>
                    </div>
                </div>
                
                <details style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <summary style="cursor: pointer; font-weight: 600; color: var(--tum-dark); font-size: 14px;">View Full Response</summary>
                    <pre style="margin-top: 10px; font-size: 11px; color: #666; white-space: pre-wrap; word-wrap: break-word;">${JSON.stringify(data, null, 2)}</pre>
                </details>
            `;
            
            container.style.display = 'block';
        }
        
        async function resubmitWithClarification(originalQuery, originalContext) {
            const clarification = document.getElementById('user-clarification-input')?.value.trim();
            
            if (!clarification) {
                alert('Please provide the missing information before submitting');
                return;
            }
            
            // Combine original context with clarification
            const enhancedContext = originalContext 
                ? `${originalContext}. Additional clarification: ${clarification}` 
                : `Additional clarification: ${clarification}`;
            
            // Update the input fields
            document.getElementById('task-input').value = originalQuery;
            document.getElementById('additional-context-input').value = enhancedContext;
            
            // Resubmit the query
            await submitQuery();
        }

        async function executeAutonomousTasking() {
            currentTaskId = 'autonomous-tasking';
            updateTaskDetails('Autonomous Tasking', 'In Progress');
            showReasoningTimeline();
            clearTimeline();
            
            const container = document.getElementById('task-results');
            const content = document.getElementById('results-content');
            if (content) content.innerHTML = '';
            if (container) container.style.display = 'none';
            try {
                const task = (document.getElementById('task-input').value || '').trim();
                const additionalContext = (document.getElementById('additional-context-input').value || '').trim();
                
                addTimelineItem('reasoning', 'Processing Task', 'Using LLM to analyze and execute task...');
                
                const requestBody = { task };
                if (additionalContext) {
                    requestBody.additional_context = additionalContext;
                }
                
                const response = await fetch('/api/autonomous-tasking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Tasking failed');
                }
                
                const reasoningLog = data.reasoning_log || [];
                
                for (let i = 0; i < reasoningLog.length; i++) {
                    const step = reasoningLog[i];
                    const stepType = step.step.includes('TOOL') ? 'tool-call' : 'reasoning';
                    const confidence = step.confidence && !isNaN(step.confidence) ? ` [Confidence: ${(step.confidence * 100).toFixed(0)}%]` : '';
                    
                    addEnhancedTimelineItem(step, stepType, confidence);
                }
                
                const cycles = data.total_cycles || data.total_iterations || 1;
                addTimelineItem('completed', 'Reasoning Complete', 
                    `Completed in ${cycles} cycle(s) with ${reasoningLog.length} total steps`);
                
                // Display the final results
                displayAutonomousTaskingResults(data);
                updateTaskDetails('Autonomous Tasking', 'Completed');
                
                // Also display in Results section
                displayInResultsSection(data, 'autonomous_tasking');
                
            } catch (error) {
                addTimelineItem('error', 'Tasking Error', `Error: ${error.message}`);
                updateTaskDetails('Autonomous Tasking', 'Error');
            }
        }

        function displayAutonomousTaskingResults(data) {
            const container = document.getElementById('task-results');
            const content = document.getElementById('results-content');
            const shipCount = data.ship_count ?? (data.data_fusion_result && data.data_fusion_result.ship_count);
            const confidence = data.confidence ?? (data.data_fusion_result && data.data_fusion_result.confidence);
            const summaryImage = data.summary_image ?? (data.data_fusion_result && data.data_fusion_result.summary_image);
            const sats = data.assigned_satellites || [];
            const sensors = data.activated_sensors || [];
            const reasoningItems = (data.reasoning_log || []).map(r => `
                <div class="reasoning-item">
                    <div class="reasoning-meta"><span>${r.step}</span> ‚Ä¢ <span>${r.model || 'LLM'}</span></div>
                    <div class="reasoning-text">${r.summary || ''}</div>
                </div>
            `).join('');
            const messageItems = (data.messages || []).map(m => {
                const content = typeof m === 'string' ? m : (m.content || '');
                const step = typeof m === 'object' ? (m.step || '') : '';
                const confidence = typeof m === 'object' && m.confidence && !isNaN(m.confidence) ? ` [${(m.confidence * 100).toFixed(0)}%]` : '';
                return `
                    <div class="message-item">
                        ${step ? `<div class="message-header">${step}${confidence}</div>` : ''}
                        <pre class="model-message">${content.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre>
                    </div>
                `;
            }).join('');

            content.innerHTML = `
                <div class="result-item"><span class="result-label">Task:</span> <span class="result-value">${data.task || '‚Äî'}</span></div>
                <div class="result-item"><span class="result-label">Assigned Satellites:</span> <span class="result-value">${sats.join(', ') || '‚Äî'}</span></div>
                <div class="result-item"><span class="result-label">Activated Sensors:</span> <span class="result-value">${sensors.join(', ') || '‚Äî'}</span></div>
                <div class="result-item"><span class="result-label">Ship Count:</span> <span class="result-value">${shipCount ?? '‚Äî'}</span></div>
                <div class="result-item"><span class="result-label">Confidence:</span> <span class="result-value">${confidence ?? '‚Äî'}</span></div>
                <div class="result-item"><span class="result-label">Report Time:</span> <span class="result-value">${data.report_time || '‚Äî'}</span></div>
                ${summaryImage ? `<div class="result-item"><span class="result-label">Summary Image:</span> <span class="result-value">${summaryImage}</span></div>` : ''}
                ${reasoningItems ? `<details class="reasoning-log"><summary>Reasoning Log</summary>${reasoningItems}</details>` : ''}
                ${messageItems ? `<details class="messages-log"><summary>Model Messages</summary>${messageItems}</details>` : ''}
            `;
            container.style.display = 'block';
        }

        async function loadConstellationStatus() {
            try {
                const el = document.getElementById('constellation-status');
                if (!el) return;
                el.textContent = 'Loading constellation info...';
                const res = await fetch('/api/constellation/status');
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Status error');
                const satCount = data.available_satellites ? Object.keys(data.available_satellites).length : 0;
                el.innerHTML = `
                    Status: ${data.status || '‚Äî'}<br>
                    Available Satellites: ${satCount}<br>
                    Active Assignments: ${data.active_assignments || 0}
                `;
            } catch (e) {
                const el = document.getElementById('constellation-status');
                if (el) el.textContent = `Error: ${e.message}`;
            }
        }

        function updateTaskDetails(title, status) {
            document.getElementById('selected-task-title').textContent = title;
            document.getElementById('selected-task-status').textContent = status;
        }

        function showReasoningTimeline() {
            document.getElementById('reasoning-timeline').style.display = 'block';
        }

        function clearTimeline() {
            document.getElementById('timeline-items').innerHTML = '';
        }

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function addEnhancedTimelineItem(step, stepType, confidenceText) {
            const container = document.getElementById('timeline-items');
            const time = new Date().toLocaleTimeString();
            
            let detailsHTML = '';
            
            // Extract phase-specific details (support both CoALA and legacy phases)
            const stepUpper = step.step.toUpperCase();
            if (stepUpper.includes('PLANNING') || stepUpper.includes('THINK') || stepUpper.includes('PLAN')) {
                const details = [];
                // CoALA planning details
                if (step.reasoning) details.push(`<strong>Reasoning:</strong> ${escapeHTML(step.reasoning)}`);
                if (step.action_selected) details.push(`<strong>Selected Action:</strong> ${escapeHTML(step.action_selected)}`);
                if (step.action_parameters) {
                    const params = JSON.stringify(step.action_parameters, null, 2);
                    details.push(`<strong>Parameters:</strong><pre style="margin: 5px 0; padding: 8px; background: #fff; border-radius: 3px; font-size: 11px;">${escapeHTML(params)}</pre>`);
                }
                // Legacy details
                if (step.task_understanding) details.push(`<strong>Task Understanding:</strong> ${escapeHTML(step.task_understanding)}`);
                if (step.relevant_tools && step.relevant_tools.length > 0) {
                    details.push(`<strong>Relevant Tools:</strong> ${escapeHTML(step.relevant_tools.join(', '))}`);
                }
                if (step.problem_analysis) details.push(`<strong>Problem Analysis:</strong> ${escapeHTML(step.problem_analysis)}`);
                if (step.execution_plan && step.execution_plan.length > 0) {
                    const planSteps = step.execution_plan.map((s, idx) => 
                        `${idx + 1}. <strong>${escapeHTML(s.action || 'unknown')}</strong>: ${escapeHTML(s.reason || 'no reason')}`
                    ).join('<br>');
                    details.push(`<strong>Execution Plan:</strong><br>${planSteps}`);
                }
                if (details.length > 0) {
                    detailsHTML = `<details>
                        <summary>View Planning Details</summary>
                        <div style="margin-top: 10px; font-size: 13px; line-height: 1.6;">${details.join('<br><br>')}</div>
                    </details>`;
                }
            } else if (stepUpper.includes('EXECUTION') || stepUpper.includes('EXECUTE')) {
                const details = [];
                // CoALA execution details
                if (step.results) {
                    const results = JSON.stringify(step.results, null, 2);
                    details.push(`<strong>Execution Results:</strong><pre style="margin: 5px 0; padding: 8px; background: #fff; border-radius: 3px; font-size: 11px;">${escapeHTML(results)}</pre>`);
                }
                // Legacy tool results
                if (step.tool_results) {
                    const results = Object.entries(step.tool_results).map(([tool, result]) => {
                        const status = result.status || (result.error ? 'error' : 'success');
                        const statusColor = status === 'success' ? '#27ae60' : 
                                          status === 'not_implemented' ? '#f39c12' : '#e74c3c';
                        return `<div style="margin-bottom: 8px;">
                            <strong>${escapeHTML(tool)}:</strong> <span style="color: ${statusColor};">${escapeHTML(status)}</span>
                            ${result.error ? `<br><span style="color: #666; font-size: 12px;">Error: ${escapeHTML(result.error)}</span>` : ''}
                        </div>`;
                    }).join('');
                    details.push(`<strong>Tool Results:</strong><br>${results}`);
                }
                if (step.execution_summary) details.push(`<strong>Summary:</strong> ${escapeHTML(step.execution_summary)}`);
                if (details.length > 0) {
                    detailsHTML = `<details>
                        <summary>View Execution Results</summary>
                        <div style="margin-top: 10px; font-size: 13px; line-height: 1.6;">${details.join('<br><br>')}</div>
                    </details>`;
                }
            } else if (stepUpper.includes('REFLECT') || stepUpper.includes('COMPLETED')) {
                const details = [];
                if (step.goal_achievement) details.push(`<strong>Goal Achievement:</strong> ${escapeHTML(step.goal_achievement)}`);
                if (step.new_insights && step.new_insights.length > 0) {
                    details.push(`<strong>New Insights:</strong><ul style="margin: 5px 0; padding-left: 20px;">${step.new_insights.map(i => `<li>${escapeHTML(i)}</li>`).join('')}</ul>`);
                }
                if (step.task_status) {
                    const statusColor = step.task_status === 'completed' ? '#27ae60' : 
                                      step.task_status === 'pending' ? '#f39c12' : 
                                      step.task_status === 'blocked' ? '#e74c3c' : '#666';
                    details.push(`<strong>Task Status:</strong> <span style="color: ${statusColor}; font-weight: 600;">${step.task_status}</span>`);
                }
                if (step.should_continue !== undefined) {
                    details.push(`<strong>Continue Reasoning:</strong> ${step.should_continue ? 'Yes' : 'No'}`);
                }
                if (step.recommendation) details.push(`<strong>Recommendation:</strong> ${escapeHTML(step.recommendation)}`);
                if (details.length > 0) {
                    detailsHTML = `<details>
                        <summary>View Details</summary>
                        <div style="margin-top: 10px; font-size: 13px; line-height: 1.6;">${details.join('<br><br>')}</div>
                    </details>`;
                }
            }
            
            const timelineItem = document.createElement('div');
            timelineItem.className = `timeline-item ${stepType}`;
            
            // Create header
            const header = document.createElement('div');
            header.className = 'timeline-header';
            
            const typeDiv = document.createElement('div');
            typeDiv.className = 'timeline-type';
            typeDiv.textContent = step.step;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'timeline-time';
            timeDiv.textContent = time;
            
            header.appendChild(typeDiv);
            header.appendChild(timeDiv);
            
            // Create content
            const content = document.createElement('div');
            content.className = 'timeline-content';
            
            const summarySpan = document.createElement('span');
            summarySpan.textContent = step.summary;
            content.appendChild(summarySpan);
            
            if (confidenceText) {
                const confSpan = document.createElement('span');
                confSpan.innerHTML = confidenceText;
                content.appendChild(confSpan);
            }
            
            // Add details if present
            if (detailsHTML) {
                const detailsContainer = document.createElement('div');
                detailsContainer.innerHTML = detailsHTML;
                content.appendChild(detailsContainer);
            }
            
            timelineItem.appendChild(header);
            timelineItem.appendChild(content);
            
            container.appendChild(timelineItem);
            container.scrollTop = container.scrollHeight;
        }

        function addTimelineItem(type, title, content) {
            const container = document.getElementById('timeline-items');
            const time = new Date().toLocaleTimeString();
            
            const timelineItem = document.createElement('div');
            timelineItem.className = `timeline-item ${type}`;
            timelineItem.innerHTML = `
                <div class="timeline-header">
                    <div class="timeline-type">${escapeHTML(title)}</div>
                    <div class="timeline-time">${time}</div>
                </div>
                <div class="timeline-content">${escapeHTML(content)}</div>
            `;
            
            container.appendChild(timelineItem);
            container.scrollTop = container.scrollHeight;
        }

        function addToolCall(functionName, parameters) {
            const container = document.getElementById('timeline-items');
            const time = new Date().toLocaleTimeString();
            
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item tool-call';
            timelineItem.innerHTML = `
                <div class="timeline-header">
                    <div class="timeline-type">Tool Call</div>
                    <div class="timeline-time">${time}</div>
                </div>
                <div class="tool-call-code">${escapeHTML(functionName)}(${escapeHTML(JSON.stringify(parameters, null, 2))})</div>
            `;
            
            container.appendChild(timelineItem);
            container.scrollTop = container.scrollHeight;
        }

        // History functionality
        let currentHistoryFilter = '';
        
        async function loadTaskHistory() {
            try {
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '<div class="loading-message">Loading task history...</div>';
                
                const response = await fetch('/api/task-history?limit=20');
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayTaskHistory(data.tasks);
                    updateHistoryStats(data.tasks);
                } else {
                    historyList.innerHTML = '<div class="loading-message">Error loading task history</div>';
                }
            } catch (error) {
                console.error('Error loading task history:', error);
                document.getElementById('historyList').innerHTML = '<div class="loading-message">Error loading task history</div>';
            }
        }
        
        function displayTaskHistory(tasks) {
            const historyList = document.getElementById('historyList');
            
            if (tasks.length === 0) {
                historyList.innerHTML = '<div class="loading-message">No task history available</div>';
                return;
            }
            
            const filteredTasks = currentHistoryFilter ? 
                tasks.filter(task => task.situation_type === currentHistoryFilter) : 
                tasks;
            
            historyList.innerHTML = filteredTasks.map(task => {
                const confidence = task.confidence && !isNaN(task.confidence) ? Math.round(task.confidence * 100) : 0;
                const confidenceClass = confidence >= 80 ? 'confidence-high' : 
                                      confidence >= 60 ? 'confidence-medium' : 'confidence-low';
                
                const timestamp = new Date(task.timestamp).toLocaleString();
                const summary = task.result?.situation_summary || task.result?.summary?.situation_summary || 'No summary available';
                
                let taskTitle = '';
                if (task.situation_type === 'collision_assessment') {
                    taskTitle = `Collision Assessment - ${task.satellite_id || 'Unknown Satellite'}`;
                } else if (task.situation_type === 'autonomous_tasking') {
                    const taskText = task.task_request?.task || 'Unknown Task';
                    taskTitle = `Autonomous Tasking - ${taskText.substring(0, 50)}${taskText.length > 50 ? '...' : ''}`;
                } else {
                    taskTitle = `Task #${task.id}`;
                }
                
                return `
                    <div class="history-item ${task.situation_type}">
                        <div class="history-header">
                            <h3 class="history-title">${taskTitle}</h3>
                            <div class="history-timestamp">${timestamp}</div>
                        </div>
                        <div class="history-meta">
                            <div class="history-meta-item">
                                <span>üìä</span>
                                <span>ID: ${task.id}</span>
                            </div>
                            <div class="history-meta-item">
                                <span>üéØ</span>
                                <span>Type: ${task.situation_type.replace('_', ' ')}</span>
                            </div>
                            <div class="history-meta-item">
                                <span>üìà</span>
                                <span class="confidence-badge ${confidenceClass}">${confidence}%</span>
                            </div>
                            <div class="history-meta-item">
                                <span>‚úÖ</span>
                                <span>Status: ${task.status}</span>
                            </div>
                        </div>
                        <div class="history-summary">${summary}</div>
                        <div class="history-actions">
                            <button class="btn-small btn-view" onclick="viewTaskDetails(${task.id})">View Details</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateHistoryStats(tasks) {
            const totalTasks = tasks.length;
            const collisionTasks = tasks.filter(t => t.situation_type === 'collision_assessment').length;
            const taskingTasks = tasks.filter(t => t.situation_type === 'autonomous_tasking').length;
            const avgConfidence = tasks.length > 0 ? 
                Math.round(tasks.reduce((sum, t) => sum + (t.confidence && !isNaN(t.confidence) ? t.confidence : 0), 0) / tasks.length * 100) : 0;
            
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('collisionTasks').textContent = collisionTasks;
            document.getElementById('taskingTasks').textContent = taskingTasks;
            document.getElementById('avgConfidence').textContent = avgConfidence + '%';
        }
        
        function filterTaskHistory() {
            const filter = document.getElementById('historyFilter').value;
            currentHistoryFilter = filter;
            loadTaskHistory();
        }
        
        async function viewTaskDetails(taskId) {
            try {
                const response = await fetch(`/api/task-history/${taskId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    showTaskDetailsModal(data.task);
                } else {
                    alert('Error loading task details');
                }
            } catch (error) {
                console.error('Error loading task details:', error);
                alert('Error loading task details');
            }
        }
        
        function showTaskDetailsModal(task) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 8px; padding: 30px; max-width: 800px; 
                max-height: 80vh; overflow-y: auto; position: relative;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '√ó';
            closeBtn.style.cssText = `
                position: absolute; top: 10px; right: 15px; background: none; border: none; 
                font-size: 24px; cursor: pointer; color: #666;
            `;
            closeBtn.onclick = () => document.body.removeChild(modal);
            
            const reasoningSteps = (task.reasoning_steps || []).map(step => `
                <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <strong>${step.state || 'Unknown'}</strong> (${step.confidence && !isNaN(step.confidence) ? Math.round(step.confidence * 100) : 0}%)
                    <div style="font-size: 14px; color: #666; margin-top: 5px;">${step.reasoning || step.message || 'No details'}</div>
                </div>
            `).join('');
            
            content.innerHTML = `
                ${closeBtn.outerHTML}
                <h2 style="margin-top: 0; color: var(--tum-dark);">Task Details #${task.id}</h2>
                <div style="margin-bottom: 20px;">
                    <strong>Type:</strong> ${task.situation_type.replace('_', ' ')}<br>
                    <strong>Timestamp:</strong> ${new Date(task.timestamp).toLocaleString()}<br>
                    <strong>Confidence:</strong> ${task.confidence && !isNaN(task.confidence) ? Math.round(task.confidence * 100) : 0}%<br>
                    <strong>Status:</strong> ${task.status}
                </div>
                <h3>Reasoning Steps:</h3>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${reasoningSteps || '<div style="color: #666;">No reasoning steps available</div>'}
                </div>
                <h3>Result Summary:</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    ${task.result?.situation_summary || task.result?.summary?.situation_summary || 'No summary available'}
                </div>
                <button onclick="document.body.removeChild(this.closest('div').parentElement)" 
                        style="background: var(--tum-blue); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                    Close
                </button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        async function clearTaskHistory() {
            if (confirm('Are you sure you want to clear all task history? This action cannot be undone.')) {
                try {
                    const response = await fetch('/api/task-history/clear', { method: 'POST' });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        loadTaskHistory();
                        alert('Task history cleared successfully');
                    } else {
                        alert('Error clearing task history');
                    }
                } catch (error) {
                    console.error('Error clearing task history:', error);
                    alert('Error clearing task history');
                }
            }
        }

        // Results section functions
        let currentResultsData = null;
        
        function displayInResultsSection(data, taskType) {
            currentResultsData = data;
            
            // Hide empty state, show content (if elements exist)
            const emptyEl = document.getElementById('results-empty');
            const contentEl = document.getElementById('results-content');
            if (emptyEl) emptyEl.style.display = 'none';
            if (contentEl) contentEl.style.display = 'block';
            
            // Update title (if elements exist)
            const titleEl = document.getElementById('results-title');
            const subtitleEl = document.getElementById('results-subtitle');
            if (titleEl) titleEl.textContent = data.task || 'Task Results';
            if (subtitleEl) subtitleEl.textContent = `Completed at ${new Date().toLocaleString()}`;
            
            // Display visualization
            const vizDiv = document.getElementById('results-visualization');
            if (!vizDiv) return; // Exit if results section doesn't exist
            if (data.annotated_image_base64) {
                vizDiv.innerHTML = `<img src="data:image/png;base64,${data.annotated_image_base64}" style="max-width: 100%; max-height: 600px; border-radius: 8px;" alt="Analysis visualization">`;
            } else {
                vizDiv.innerHTML = '<p style="color: #999;">No visualization data available for this task type</p>';
            }
            
            // Display metrics
            const metricsDiv = document.getElementById('results-metrics');
            const metrics = [];
            
            // Extract relevant metrics based on task type
            if (data.detections || data.annotated_image_base64) {
                // Earth Observation task
                metrics.push(
                    { label: 'Objects Detected', value: (data.detections?.length || 0).toString() },
                    { label: 'Confidence', value: `${Math.round((data.confidence || 0) * 100)}%` },
                    { label: 'Region', value: data.region || '-' },
                    { label: 'Status', value: data.status || 'completed' }
                );
            } else if (data.assigned_satellites) {
                // Constellation task
                metrics.push(
                    { label: 'Satellites Assigned', value: data.assigned_satellites.length.toString() },
                    { label: 'Sensors Activated', value: data.activated_sensors?.length.toString() || '0' },
                    { label: 'Confidence', value: `${Math.round((data.confidence || 0) * 100)}%` },
                    { label: 'Task Status', value: data.task_status || 'completed' }
                );
            } else {
                // Generic task
                metrics.push(
                    { label: 'Status', value: data.status || data.task_status || 'completed' },
                    { label: 'Confidence', value: `${Math.round((data.confidence || 0) * 100)}%` }
                );
            }
            
            metricsDiv.innerHTML = metrics.map(m => `
                <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid var(--tum-blue);">
                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 5px;">${m.label}</div>
                    <div style="font-size: 20px; font-weight: bold; color: var(--tum-dark);">${m.value}</div>
                </div>
            `).join('');
            
            // Display detailed results
            document.getElementById('results-details').textContent = JSON.stringify(data, null, 2);
            
            // Switch to Results tab
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector('[data-section="results"]').classList.add('active');
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            document.getElementById('results').classList.add('active');
        }
        
        function downloadResults() {
            if (!currentResultsData) {
                alert('No results available to download');
                return;
            }
            
            const dataStr = JSON.stringify(currentResultsData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `task_results_${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        function clearResults() {
            currentResultsData = null;
            const emptyEl = document.getElementById('results-empty');
            const contentEl = document.getElementById('results-content');
            if (emptyEl) emptyEl.style.display = 'block';
            if (contentEl) contentEl.style.display = 'none';
        }

        async function loadMemoryStatus() {
            const statusElement = document.getElementById('memory-status-inline');
            if (!statusElement) return;
            
            try {
                statusElement.textContent = 'Loading...';
                const response = await fetch('/api/memory/status');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const mem = data.memory_modules;
                    const episodicCount = mem.episodic.size;
                    const semanticCount = mem.semantic.size;
                    const proceduralCount = mem.procedural.size;
                    
                    statusElement.innerHTML = `
                        Episodic: <strong>${episodicCount} episodes</strong> | 
                        Semantic: <strong>${semanticCount} facts</strong> | 
                        Procedural: <strong>${proceduralCount} patterns</strong>
                    `;
                } else {
                    statusElement.textContent = 'Error loading memory status';
                }
            } catch (error) {
                console.error('Failed to load memory status:', error);
                statusElement.textContent = 'Failed to load memory status';
            }
        }

        // Satellite tracker functions
        const SATELLITE_API_URL = 'http://localhost:8000';
        let satellitesCache = [];

        async function loadSatellites() {
            const searchTerm = document.getElementById('sat-search').value.trim();
            const limit = document.getElementById('sat-limit').value;
            const statusDiv = document.getElementById('sat-status');
            const loadingDiv = document.getElementById('sat-loading');
            const tableDiv = document.getElementById('sat-table');
            const emptyDiv = document.getElementById('sat-empty');
            
            statusDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            tableDiv.style.display = 'none';
            emptyDiv.style.display = 'none';
            
            try {
                let url = `${SATELLITE_API_URL}/satellites?limit=${limit}`;
                if (searchTerm) {
                    url += `&constellation=${encodeURIComponent(searchTerm)}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                satellitesCache = data.data || [];
                
                if (satellitesCache.length === 0) {
                    loadingDiv.style.display = 'none';
                    emptyDiv.style.display = 'block';
                    return;
                }
                
                // Update statistics
                updateSatelliteStats(satellitesCache);
                
                // Populate table
                const tbody = document.getElementById('sat-table-body');
                tbody.innerHTML = satellitesCache.map(sat => `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px;">${sat.norad_id}</td>
                        <td style="padding: 12px; font-weight: 500;">${sat.name || 'Unknown'}</td>
                        <td style="padding: 12px;">${sat.country || '-'}</td>
                        <td style="padding: 12px;">${sat.operator || '-'}</td>
                        <td style="padding: 12px;"><span style="padding: 4px 8px; background: ${getOrbitColor(sat.orbit_type)}; color: white; border-radius: 3px; font-size: 12px;">${sat.orbit_type || 'UNKNOWN'}</span></td>
                        <td style="padding: 12px; font-size: 13px;">${sat.mission_type || '-'}</td>
                        <td style="padding: 12px;">
                            <button onclick="viewSatelliteDetails(${sat.norad_id})" style="padding: 6px 12px; background: var(--tum-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Details</button>
                            <button onclick="focusSatellite(${sat.norad_id})" style="padding: 6px 12px; background: #2e7d32; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 4px;">üåç Focus</button>
                        </td>
                    </tr>
                `).join('');
                
                loadingDiv.style.display = 'none';
                tableDiv.style.display = 'table';
                
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#e8f5e9';
                statusDiv.style.color = '#2e7d32';
                statusDiv.textContent = `‚úì Loaded ${satellitesCache.length} satellite(s) | Total in DB: ${data.count}`;
                
                // Update 3D visualization if active
                if (vizInitialized) updateVisualization();

            } catch (error) {
                console.error('Error loading satellites:', error);
                loadingDiv.style.display = 'none';
                emptyDiv.style.display = 'block';
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#ffebee';
                statusDiv.style.color = '#c62828';
                statusDiv.innerHTML = `‚úó Error: ${error.message}. Make sure the API server is running: <code>python run_satellite_api.py</code>`;
            }
        }

        function updateSatelliteStats(satellites) {
            const total = satellites.length;
            const leo = satellites.filter(s => s.orbit_type === 'LEO').length;
            const meo = satellites.filter(s => s.orbit_type === 'MEO').length;
            const geo = satellites.filter(s => s.orbit_type === 'GEO').length;
            
            document.getElementById('total-sats').textContent = total.toLocaleString();
            document.getElementById('leo-sats').textContent = leo.toLocaleString();
            document.getElementById('meo-sats').textContent = meo.toLocaleString();
            document.getElementById('geo-sats').textContent = geo.toLocaleString();
        }

        function getOrbitColor(orbitType) {
            const colors = {
                'LEO': '#4caf50',
                'MEO': '#ff9800',
                'GEO': '#f44336',
                'xGEO': '#9c27b0',
                'UNKNOWN': '#757575'
            };
            return colors[orbitType] || colors.UNKNOWN;
        }

        async function viewSatelliteDetails(noradId) {
            const modal = document.getElementById('sat-details-modal');
            const modalTitle = document.getElementById('modal-sat-name');
            const modalContent = document.getElementById('modal-sat-content');
            
            modal.style.display = 'block';
            modalTitle.textContent = `Loading...`;
            modalContent.innerHTML = '<div style="text-align: center; padding: 40px;">Loading satellite data...</div>';
            
            try {
                // Get satellite info
                const satInfo = satellitesCache.find(s => s.norad_id === noradId);
                if (!satInfo) {
                    throw new Error('Satellite not found in cache');
                }
                
                modalTitle.textContent = `${satInfo.name} (NORAD ${noradId})`;
                
                // Get TLE history
                const tleResponse = await fetch(`${SATELLITE_API_URL}/tle/${noradId}/history?days=30`);
                const tleData = await tleResponse.json();
                
                const tleHistory = tleData.history || [];
                const tleTable = tleHistory.length > 0 ? `
                    <h4>Recent TLE Data (Last 30 days)</h4>
                    <div style="max-height: 300px; overflow-x: auto; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead style="position: sticky; top: 0; background: white;">
                                <tr style="background: #f5f5f5;">
                                    <th style="padding: 8px; text-align: left;">Collected</th>
                                    <th style="padding: 8px; text-align: left;">Semi-major Axis (km)</th>
                                    <th style="padding: 8px; text-align: left;">Eccentricity</th>
                                    <th style="padding: 8px; text-align: left;">Inclination (¬∞)</th>
                                    <th style="padding: 8px; text-align: left;">RAAN (¬∞)</th>
                                    <th style="padding: 8px; text-align: left;">AOP (¬∞)</th>
                                    <th style="padding: 8px; text-align: left;">Mean Anomaly (¬∞)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tleHistory.slice(0, 10).map(tle => `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 8px;">${new Date(tle.collected_at).toLocaleString()}</td>
                                        <td style="padding: 8px;">${tle.a ? tle.a.toFixed(3) : 'N/A'}</td>
                                        <td style="padding: 8px;">${tle.e ? tle.e.toFixed(6) : 'N/A'}</td>
                                        <td style="padding: 8px;">${tle.i ? tle.i.toFixed(3) : 'N/A'}</td>
                                        <td style="padding: 8px;">${tle.raan !== null && tle.raan !== undefined ? tle.raan.toFixed(3) : 'N/A'}</td>
                                        <td style="padding: 8px;">${tle.aop !== null && tle.aop !== undefined ? tle.aop.toFixed(3) : 'N/A'}</td>
                                        <td style="padding: 8px;">${tle.mean_anomaly !== null && tle.mean_anomaly !== undefined ? tle.mean_anomaly.toFixed(3) : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : '<div style="color: #999;">No TLE history available</div>';
                
                modalContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div>
                            <strong>NORAD ID:</strong> ${satInfo.norad_id}<br>
                            <strong>Country:</strong> ${satInfo.country || 'Unknown'}<br>
                            <strong>Operator:</strong> ${satInfo.operator || 'Unknown'}<br>
                            <strong>Mission Type:</strong> ${satInfo.mission_type || 'Unknown'}
                        </div>
                        <div>
                            <strong>Orbit Type:</strong> <span style="padding: 4px 8px; background: ${getOrbitColor(satInfo.orbit_type)}; color: white; border-radius: 3px;">${satInfo.orbit_type || 'UNKNOWN'}</span><br>
                            <strong>Launched:</strong> ${satInfo.launched || 'Unknown'}<br>
                            <strong>Last Updated:</strong> ${satInfo.last_updated ? new Date(satInfo.last_updated).toLocaleString() : 'Unknown'}
                        </div>
                    </div>
                    ${tleTable}
                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 4px;">
                        <strong>üí° Tip:</strong> You can also query this satellite via the AI interface by asking:<br>
                        <code style="display: block; margin-top: 5px; padding: 8px; background: white; border-radius: 3px;">Get satellite data for NORAD ID ${noradId}</code>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading satellite details:', error);
                modalContent.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #c62828;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div>Error loading satellite details: ${error.message}</div>
                    </div>
                `;
            }
        }

        function closeSatelliteDetails() {
            document.getElementById('sat-details-modal').style.display = 'none';
        }

        function refreshSatelliteData() {
            loadSatellites();
        }

        // 3D Visualization (Cesium)
        let cesiumViewer = null;
        let satelliteEntities = [];
        let orbitEntities = [];
        let showOrbits = false;
        let showLabels = true;
        let vizInitialized = false;

        function toggleVisualization() {
            const content = document.getElementById('viz-content');
            const btn = document.getElementById('viz-toggle-btn');
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                btn.textContent = 'Show Globe';
            } else {
                content.classList.add('active');
                btn.textContent = 'Hide Globe';
                if (!vizInitialized) initCesium();
            }
        }

        async function initCesium() {
            try {
                // Use ESRI World Imagery tiles (free, no API key needed)
                const esriImagery = await Cesium.ArcGisMapServerImageryProvider.fromUrl(
                    'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer'
                );
                
                cesiumViewer = new Cesium.Viewer('cesiumContainer', {
                    baseLayer: new Cesium.ImageryLayer(esriImagery),
                    baseLayerPicker: false,
                    geocoder: false,
                    homeButton: false,
                    sceneModePicker: false,
                    navigationHelpButton: false,
                    animation: false,
                    timeline: false,
                    fullscreenButton: false,
                    vrButton: false,
                    infoBox: false,
                    selectionIndicator: true
                });
                cesiumViewer.scene.globe.enableLighting = false;
                
                // Add TUM Munich marker for orientation
                cesiumViewer.entities.add({
                    name: 'TUM Munich',
                    position: Cesium.Cartesian3.fromDegrees(11.568, 48.149, 0),
                    point: { pixelSize: 10, color: Cesium.Color.RED },
                    label: {
                        text: 'TUM Munich',
                        font: '12px sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -12)
                    }
                });
                
                cesiumViewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(11.5, 48.1, 20000000)
                });
                vizInitialized = true;
                document.getElementById('viz-status').textContent = 'Globe ready. Load satellites to display.';
                if (satellitesCache.length > 0) updateVisualization();
            } catch (e) {
                console.error('Cesium init error:', e);
                document.getElementById('viz-status').textContent = 'Error: ' + e.message;
            }
        }

        function resetView() {
            if (!cesiumViewer) return;
            cesiumViewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(11.5, 48.1, 20000000),
                duration: 1.5
            });
        }

        function toggleOrbits() {
            showOrbits = !showOrbits;
            orbitEntities.forEach(e => { e.show = showOrbits; });
        }

        function toggleLabels() {
            showLabels = !showLabels;
            satelliteEntities.forEach(e => { if (e.label) e.label.show = showLabels; });
        }

        let vizSizeMode = 0; // 0=normal, 1=expanded, 2=fullscreen
        function toggleVizSize() {
            const panel = document.querySelector('.viz-panel');
            const content = document.getElementById('viz-content');
            const btn = document.getElementById('viz-size-btn');
            
            vizSizeMode = (vizSizeMode + 1) % 3;
            
            content.classList.remove('expanded');
            panel.classList.remove('fullscreen');
            
            if (vizSizeMode === 1) {
                content.classList.add('expanded');
                btn.textContent = '‚õ∂ Fullscreen';
            } else if (vizSizeMode === 2) {
                panel.classList.add('fullscreen');
                content.classList.add('active');
                btn.textContent = '‚õ∂ Normal';
            } else {
                btn.textContent = '‚õ∂ Expand';
            }
            
            // Resize Cesium viewer
            if (cesiumViewer) setTimeout(() => cesiumViewer.resize(), 100);
        }

        async function updateVisualization() {
            if (!cesiumViewer || satellitesCache.length === 0) return;
            
            // Clear old entities
            satelliteEntities.forEach(e => cesiumViewer.entities.remove(e));
            orbitEntities.forEach(e => cesiumViewer.entities.remove(e));
            satelliteEntities = [];
            orbitEntities = [];
            
            const statusEl = document.getElementById('viz-status');
            const vizLimit = Math.min(satellitesCache.length, 500);
            statusEl.textContent = `Loading ${vizLimit} satellites...`;

            // Get TLE data for satellites (limit for performance - each requires API call)
            const satsToShow = satellitesCache.slice(0, vizLimit);
            let loaded = 0;
            
            for (const sat of satsToShow) {
                try {
                    const resp = await fetch(`${SATELLITE_API_URL}/tle/${sat.norad_id}/history?days=1`);
                    const data = await resp.json();
                    if (data.history && data.history.length > 0) {
                        const tle = data.history[0];
                        if (tle.tle_line1 && tle.tle_line2) {
                            addSatelliteToGlobe(sat, tle.tle_line1, tle.tle_line2);
                            loaded++;
                        }
                    }
                } catch (e) { /* skip failed */ }
            }
            
            statusEl.textContent = `Showing ${loaded} satellites`;
        }

        function addSatelliteToGlobe(sat, line1, line2) {
            try {
                const satrec = satellite.twoline2satrec(line1, line2);
                const now = new Date();
                const posVel = satellite.propagate(satrec, now);
                if (!posVel.position) return;
                
                const gmst = satellite.gstime(now);
                const geo = satellite.eciToGeodetic(posVel.position, gmst);
                const lon = satellite.degreesLong(geo.longitude);
                const lat = satellite.degreesLat(geo.latitude);
                const alt = geo.height * 1000;
                
                const color = sat.orbit_type === 'LEO' ? Cesium.Color.LIME :
                              sat.orbit_type === 'MEO' ? Cesium.Color.ORANGE :
                              sat.orbit_type === 'GEO' ? Cesium.Color.RED : Cesium.Color.WHITE;
                
                const entity = cesiumViewer.entities.add({
                    name: sat.name,
                    position: Cesium.Cartesian3.fromDegrees(lon, lat, alt),
                    point: { pixelSize: 8, color: color, outlineColor: Cesium.Color.WHITE, outlineWidth: 2 },
                    label: {
                        text: `${sat.norad_id} - ${sat.name}`,
                        font: 'bold 14px sans-serif',
                        fillColor: Cesium.Color.YELLOW,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 3,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -12),
                        disableDepthTestDistance: Number.POSITIVE_INFINITY,
                        show: showLabels
                    },
                    properties: { norad_id: sat.norad_id }
                });
                satelliteEntities.push(entity);
                
                // Orbit path
                const orbitPositions = [];
                const period = 2 * Math.PI / satrec.no;
                for (let m = 0; m <= period; m += period / 60) {
                    const t = new Date(now.getTime() + m * 60000);
                    const pv = satellite.propagate(satrec, t);
                    if (pv.position) {
                        const g = satellite.gstime(t);
                        const gd = satellite.eciToGeodetic(pv.position, g);
                        orbitPositions.push(Cesium.Cartesian3.fromDegrees(
                            satellite.degreesLong(gd.longitude),
                            satellite.degreesLat(gd.latitude),
                            gd.height * 1000
                        ));
                    }
                }
                if (orbitPositions.length > 2) {
                    const orbit = cesiumViewer.entities.add({
                        polyline: {
                            positions: orbitPositions,
                            width: 1,
                            material: color.withAlpha(0.4)
                        },
                        show: showOrbits
                    });
                    orbitEntities.push(orbit);
                }
            } catch (e) { /* skip invalid TLE */ }
        }

        function focusSatellite(noradId) {
            if (!cesiumViewer) return;
            const entity = satelliteEntities.find(e => e.properties && e.properties.norad_id && e.properties.norad_id.getValue() === noradId);
            if (entity) {
                // Fly closer to see the satellite better
                cesiumViewer.flyTo(entity, { duration: 1.5, offset: new Cesium.HeadingPitchRange(0, -Math.PI / 4, 2000000) });
                // Highlight: make point larger temporarily
                const origSize = entity.point.pixelSize.getValue();
                entity.point.pixelSize = 20;
                entity.label.fillColor = Cesium.Color.CYAN;
                setTimeout(() => { 
                    entity.point.pixelSize = origSize;
                    entity.label.fillColor = Cesium.Color.YELLOW;
                }, 5000);
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('sat-details-modal');
            if (event.target === modal) {
                closeSatelliteDetails();
            }
        });

        window.onload = function() {
            initNavigation();
            checkSystemStatus();
            loadMemoryStatus();
            loadConstellationStatus();
            setInterval(checkSystemStatus, 30000);
            setInterval(loadConstellationStatus, 60000);
            
            const historyNavItem = document.querySelector('[data-section="history"]');
            if (historyNavItem) {
                historyNavItem.addEventListener('click', loadTaskHistory);      
            }

        };

    </script>
</body>
</html>