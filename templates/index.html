<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TUM - Chair of Spacecraft Systems | Satellite Operations Control Center</title>
    <!-- Roboto Font (per TUM web) -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tum-blue: #3070b3;
            --tum-dark: #03214a;
            --tum-grey: #e9ecef;
            --sidebar-width: 250px;
        }
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            width: var(--sidebar-width);
            background: var(--tum-dark);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .chair-info-sidebar {
            font-size: 12px;
            font-weight: 400;
            color: #dbeeef;
            line-height: 1.4;
            text-align: left;
        }
        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s ease;
            border-left: 3px solid transparent;
        }
        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }
        .nav-item.active {
            background: rgba(255,255,255,0.2);
            border-left-color: #fff;
        }
        .nav-item-icon {
            margin-right: 12px;
            font-size: 16px;
            width: 20px;
            text-align: center;
            font-weight: bold;
        }
        .nav-item-text {
            font-size: 14px;
            font-weight: 500;
        }
        .sidebar-footer {
            padding: 15px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .sidebar-footer .status-indicator {
            font-size: 12px;
        }
        .sidebar-footer #llm-status-sidebar {
            font-size: 12px;
            color: #b0bec5;
        }
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
        }
        .top-header {
            background: linear-gradient(to right, var(--tum-dark), var(--tum-blue));
            color: white;
            padding: 20px 30px;
            border-bottom: 1px solid var(--tum-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .tum-logo {
            display: flex;
            align-items: center;
        }
        .tum-logo img {
            height: 48px;
            width: auto;
            vertical-align: middle;
            max-width: 200px;
        }
        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin: 0;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 30px;
        }
        .header-logo img {
            height: 40px;
            width: auto;
            max-width: 120px;
        }
        .chair-info {
            font-size: 13px;
            font-weight: 400;
            text-align: right;
            color: #dbeeef;
            line-height: 1.3;
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00cc66;
        }
        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 120px);
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .section-header {
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--tum-dark);
            margin: 0 0 8px 0;
        }
        .section-subtitle {
            color: #666;
            font-size: 14px;
            margin: 0;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .dashboard-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid var(--tum-blue);
        }
        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--tum-dark);
            margin: 0 0 10px 0;
        }
        .card-content {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        .alerts-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .alert-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .alert-item:last-child {
            border-bottom: none;
        }
        .alert-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f39c12;
        }
        .alert-icon.high {
            background: #e74c3c;
        }
        .alert-icon.low {
            background: #27ae60;
        }
        .alert-content {
            flex: 1;
        }
        .alert-title {
            font-weight: 600;
            color: var(--tum-dark);
            margin: 0 0 4px 0;
        }
        .alert-description {
            color: #666;
            font-size: 14px;
            margin: 0;
        }
        .alert-time {
            color: #999;
            font-size: 12px;
        }
        .tasks-list {
            background: transparent;
            border-radius: 8px;
            overflow: visible;
        }
        .task-item {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 15px;
            border-radius: 8px;
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .task-item:last-child {
            border-bottom: 1px solid #e0e0e0;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-title {
            font-weight: 600;
            color: var(--tum-dark);
            margin: 0;
        }
        .task-progress {
            font-size: 14px;
            color: #666;
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background: var(--tum-blue);
            transition: width 0.3s ease;
        }
        .task-description {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .tool-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .tool-icon {
            font-size: 2rem;
            margin-bottom: 15px;
        }
        .tool-name {
            font-weight: 600;
            color: var(--tum-dark);
            margin: 0 0 8px 0;
        }
        .tool-description {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
            margin: 0 0 15px 0;
        }
        .tool-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .tool-status.available {
            background: #e8f5e8;
            color: #27ae60;
        }
        .tool-status.mock {
            background: #fff3cd;
            color: #856404;
        }
        
        /* History Section Styles */
        .history-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .history-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        .history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--tum-blue);
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 60vh;
            overflow-y: auto;
        }
        .history-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid var(--tum-blue);
        }
        .history-item.collision_assessment {
            border-left-color: #dc3545;
        }
        .history-item.autonomous_tasking {
            border-left-color: #28a745;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .history-title {
            font-weight: 600;
            color: var(--tum-dark);
            margin: 0;
        }
        .history-timestamp {
            color: #666;
            font-size: 14px;
        }
        .history-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .history-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #666;
        }
        .history-summary {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .history-actions {
            display: flex;
            gap: 10px;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn-view {
            background: var(--tum-blue);
            color: white;
        }
        .btn-view:hover {
            background: var(--tum-dark);
        }
        .confidence-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .confidence-high {
            background: #d4edda;
            color: #155724;
        }
        .confidence-medium {
            background: #fff3cd;
            color: #856404;
        }
        .confidence-low {
            background: #f8d7da;
            color: #721c24;
        }
        .loading-message {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }
        
        /* Tasks Section Styles */
        .tasks-container {
            display: flex;
            gap: 30px;
            height: calc(100vh - 180px);
        }
        .tasks-column {
            flex: 1;
            min-width: 400px;
        }
        .tasks-column h3 {
            margin: 0 0 20px 0;
            color: var(--tum-dark);
            font-size: 1.1rem;
        }
        .task-button {
            background: var(--tum-blue);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background 0.3s ease;
        }
        .task-button:hover:not(:disabled) {
            background: var(--tum-dark);
        }
        .task-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .task-details-column {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .task-details-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        .task-details-header h3 {
            margin: 0 0 8px 0;
            color: var(--tum-dark);
        }
        .task-status {
            font-size: 14px;
            color: #666;
        }
        .reasoning-timeline {
            margin-bottom: 25px;
        }
        .reasoning-timeline h4 {
            margin: 0 0 15px 0;
            color: var(--tum-dark);
            font-size: 1rem;
        }
        .timeline-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid var(--tum-blue);
        }
        .timeline-item.reasoning {
            border-left-color: #3498db;
        }
        .timeline-item.tool-call {
            border-left-color: #e74c3c;
        }
        .timeline-item.completed {
            border-left-color: #27ae60;
        }
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .timeline-type {
            font-weight: 600;
            color: var(--tum-dark);
            font-size: 14px;
        }
        .timeline-time {
            font-size: 12px;
            color: #666;
        }
        .timeline-content {
            font-size: 14px;
            line-height: 1.5;
            color: #333;
        }
        .tool-call-code {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 8px 0;
            overflow-x: auto;
        }
        .task-results {
            margin-top: 25px;
        }
        .task-results h4 {
            margin: 0 0 15px 0;
            color: var(--tum-dark);
            font-size: 1rem;
        }
        .results-content {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #27ae60;
        }
        .results-content details.reasoning-log,
        .results-content details.messages-log {
            display: block;
            max-width: 100%;
            overflow: hidden;
            margin-top: 10px;
        }
        .results-content .model-message {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: anywhere;
            max-width: 100%;
            background: #fafafa;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
        }
        .result-item {
            margin-bottom: 10px;
        }
        .result-label {
            font-weight: 600;
            color: var(--tum-dark);
            margin-right: 8px;
        }
        .result-value {
            color: #333;
        }
        
        /* Mock/Real Indicators */
        .mock-indicator, .real-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
        }
        .mock-indicator {
            background: #fff3cd;
            color: #856404;
        }
        .real-indicator {
            background: #e8f5e8;
            color: #27ae60;
        }
        .mock-banner {
            background: #fff3cd;
            color: #856404;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            margin-top: 10px;
            border-left: 3px solid #ffc107;
        }
        .task-status-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin: 8px 0;
        }
        .task-status-indicator.real {
            background: #e8f5e8;
            color: #27ae60;
        }
        .task-status-indicator.mock {
            background: #fff3cd;
            color: #856404;
        }
        .tool-status.real {
            background: #e8f5e8;
            color: #27ae60;
        }
        
        /* Demo Notice */
        .demo-notice {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 30px;
        }
        .demo-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .demo-icon {
            font-size: 18px;
        }
        .demo-text {
            font-size: 14px;
            color: #1976d2;
            font-weight: 500;
        }
        
        /* Footer */
        .footer {
            background: var(--tum-dark);
            color: white;
            padding: 15px 30px;
            border-top: 1px solid var(--tum-blue);
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chair-info-footer {
            font-size: 10px;
            font-weight: 400;
            color: #dbeeef;
            line-height: 1.3;
        }
        .info-footer {
            font-size: 11px;
            color: #b0bec5;
            font-weight: 400;
            line-height: 1.4;
        }
        .info-footer .contact-label {
            font-size: 10px;
            color: #8a9ba8;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        .footer-right {
            font-size: 12px;
            color: #b0bec5;
            font-weight: 500;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            .main-content {
                margin-left: 200px;
            }
            .sidebar-logo img {
                height: 40px;
                max-width: 140px;
            }
            .content-area {
                padding: 20px;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .tools-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                width: 180px;
            }
            .main-content {
                margin-left: 180px;
            }
            .content-area {
                padding: 15px;
            }
            .top-header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
            }
            .header-left {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            .header-right {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            .header-title {
                font-size: 1.2rem;
            }
            .tum-logo img {
                height: 40px;
                max-width: 150px;
            }
            .chair-info {
                font-size: 11px;
            }
            .footer {
                padding: 12px 20px;
            }
            .footer-content {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            .chair-info-footer {
                font-size: 10px;
            }
            .footer-right {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="chair-info-sidebar">
                Chair of Spacecraft Systems<br>
                    TUM School of Engineering and Design<br>
                Technical University of Munich
            </div>
        </div>
            <div class="nav-menu">
                <div class="nav-item active" data-section="tasks">
                    <div class="nav-item-icon">ğŸ¤–</div>
                    <div class="nav-item-text">AI Query Interface</div>
                </div>
                <div class="nav-item" data-section="logs">
                    <div class="nav-item-icon">ğŸ“‹</div>
                    <div class="nav-item-text">System Logs</div>
                </div>
                <div class="nav-item" data-section="info">
                    <div class="nav-item-icon">â„¹ï¸</div>
                    <div class="nav-item-text">System Information</div>
                </div>
            </div>            <div class="sidebar-footer">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>System Online</span>
            </div>
                <div id="llm-status-sidebar">LLM: Checking...</div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <div class="top-header">
                <div class="header-left">
                    <h1 class="header-title">AUTOPS: Autonomous Satellite Operations Assistant</h1>
                </div>
                <div class="header-right">
                    <div class="header-logo">
                        <img src="/static/images/tum-logo-white.svg" alt="TUM">
                    </div>
                </div>
            </div>
            
            <!-- System Notice -->
            <div class="demo-notice">
                <div class="demo-content">
                    <span class="demo-text">
                        <strong>AI-Powered Tool Orchestration:</strong> Submit natural language queries. The system discovers and executes relevant tools dynamically.
                    </span>
            </div>
        </div>
        
            <div class="content-area">
                <!-- AI Query Interface -->
                <div class="content-section active" id="tasks">
                    <div class="section-header">
                        <h2 class="section-title">AI Query Interface</h2>
                        <p class="section-subtitle">Natural language task submission with dynamic tool orchestration</p>
                    </div>
                    
                    <!-- Two-column layout for task details and reasoning -->
                    <div class="tasks-container">
                        <!-- Left column: Task list -->
                        <div class="tasks-column">
                            <div class="tasks-list">
                                <div class="task-item" data-task="query-submission">
                                    <div class="task-header">
                                        <h4 class="task-title">Submit Query</h4>
                                    </div>
                                    <p class="task-description">
                                        Submit a natural language query. The AI agent will analyze the task, discover relevant tools, and execute them dynamically.
                                    </p>
                                    <div>
                                        <label for="task-input" style="display:block;font-size:14px;color:#333;font-weight:500;margin-bottom:5px;">Query</label>
                                        <textarea id="task-input" style="width:calc(100% - 24px);padding:12px;margin-bottom:12px;border:1px solid #ddd;border-radius:4px;font-family:inherit;resize:vertical;box-sizing:border-box;" rows="3" placeholder="Example: How many ships are currently in the Taiwan Strait?">How many ships are currently in the Taiwan Strait?</textarea>
                                        
                                        <label for="additional-context-input" style="display:block;font-size:12px;color:#666;">Additional Context (optional)</label>
                                        <input id="additional-context-input" type="text" style="width:calc(100% - 24px);padding:8px;margin-bottom:12px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;" placeholder="Example: region, time, sensor type, priority, etc." value="Taiwan Strait region, 2025-01-01, SAR imagery, high priority" />
                                    </div>
                                    <div class="task-status-indicator real">âœ… Active</div>
                                    <button class="task-button" onclick="submitQuery()">Submit Query</button>
                                </div>
        </div>
    </div>

                        <!-- Right column: Task details and reasoning timeline -->
                        <div class="task-details-column">
                            <div class="task-details-header">
                                <h3 id="selected-task-title">Select a task to view details</h3>
                                <div class="task-status" id="selected-task-status"></div>
                            </div>
            
                            <!-- Reasoning timeline -->
                            <div class="reasoning-timeline" id="reasoning-timeline" style="display: none;">
                                <h4>Events Timeline</h4>
                                <div class="timeline-items" id="timeline-items">
                                    <!-- Dynamic timeline items will be added here -->
            </div>
        </div>
        
                            <!-- Task results -->
                            <div class="task-results" id="task-results" style="display: none;">
                                <h4>Assessment Results</h4>
                                <div class="results-content" id="results-content">
                                    <!-- Dynamic results will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>
        </div>

                <!-- System Logs Section -->
                <div class="content-section" id="logs">
                    <div class="section-header">
                        <h2 class="section-title">System Logs</h2>
                        <p class="section-subtitle">Real-time execution logs with detailed traceability for validation</p>
                        <div style="margin-top: 10px; padding: 12px; background: #e3f2fd; border-left: 4px solid var(--tum-blue); border-radius: 4px; font-size: 13px;">
                            <strong>Two-Level Logging System:</strong>
                            <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                                <li><strong>UI Logs (below):</strong> Frontend execution flow, phase summaries, and user interactions</li>
                                <li><strong>Backend Logs (download):</strong> Complete LLM responses, JSON parsing, tool execution details, and full stack traces for deep debugging</li>
                            </ul>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="clearLogs()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                Clear UI Logs
                            </button>
                            <button onclick="downloadLogs()" style="background: var(--tum-blue); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                Download UI Logs
                            </button>
                            <button onclick="downloadBackendLogs()" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                ğŸ“¥ Download Backend Logs
                            </button>
                            <button onclick="clearBackendLogs()" style="background: #ff9800; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                Clear Backend Logs
                            </button>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                <input type="checkbox" id="autoScrollLogs" checked style="cursor: pointer;">
                                Auto-scroll
                            </label>
                        </div>
                    </div>

                    <div style="display: grid; gap: 20px;">
                        <!-- Log Statistics -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 28px; font-weight: 600; color: var(--tum-blue);" id="logCount">0</div>
                                <div style="font-size: 13px; color: #666; margin-top: 5px;">Total Log Entries</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 28px; font-weight: 600; color: #4caf50;" id="infoCount">0</div>
                                <div style="font-size: 13px; color: #666; margin-top: 5px;">Info Messages</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 28px; font-weight: 600; color: #ff9800;" id="warningCount">0</div>
                                <div style="font-size: 13px; color: #666; margin-top: 5px;">Warnings</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 28px; font-weight: 600; color: #f44336;" id="errorCount">0</div>
                                <div style="font-size: 13px; color: #666; margin-top: 5px;">Errors</div>
                            </div>
                        </div>

                        <!-- Log Filter -->
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <label style="font-size: 13px; font-weight: 600; color: #333;">Filter by level:</label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer;">
                                    <input type="checkbox" class="log-filter" data-level="INFO" checked style="cursor: pointer;">
                                    <span style="color: #4caf50;">INFO</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer;">
                                    <input type="checkbox" class="log-filter" data-level="WARNING" checked style="cursor: pointer;">
                                    <span style="color: #ff9800;">WARNING</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer;">
                                    <input type="checkbox" class="log-filter" data-level="ERROR" checked style="cursor: pointer;">
                                    <span style="color: #f44336;">ERROR</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer;">
                                    <input type="checkbox" class="log-filter" data-level="DEBUG" checked style="cursor: pointer;">
                                    <span style="color: #2196f3;">DEBUG</span>
                                </label>
                            </div>
                        </div>

                        <!-- Log Console -->
                        <div style="background: #1e1e1e; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden;">
                            <div style="background: #2d2d30; padding: 10px 15px; border-bottom: 1px solid #3e3e42; display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #cccccc; font-size: 13px; font-weight: 600;">Console Output</span>
                                <span style="color: #858585; font-size: 11px; font-family: 'Courier New', monospace;" id="logTimestamp">--:--:--</span>
                            </div>
                            <div id="logConsole" style="padding: 15px; font-family: 'Courier New', monospace; font-size: 11px; color: #d4d4d4; max-height: 800px; overflow-y: auto; line-height: 1.7; word-wrap: break-word;">
                                <div style="color: #858585; font-style: italic;">
                                    System logs will appear here...<br>
                                    <span style="font-size: 10px;">Detailed logs include: LLM responses, tool I/O, reasoning traces, confidence scores, and execution flow</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Information Section -->
                <div class="content-section" id="info">
                    <div class="section-header">
                        <h2 class="section-title">System Information</h2>
                        <p class="section-subtitle">Architecture overview and implementation details</p>
                    </div>

                    <div style="display: grid; gap: 25px;">
                        <!-- Overview -->
                        <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px 0; color: var(--tum-dark); font-size: 18px;">What is AUTOPS?</h3>
                            <p style="margin: 0 0 12px 0; line-height: 1.6; color: #333;">
                                AUTOPS (Autonomous Satellite Operations Assistant) is an AI-powered system that enables natural language interaction with satellite operations tools. 
                                The system uses a dual LLM architecture to analyze queries, dynamically discover relevant tools, and orchestrate their execution through iterative reasoning.
                            </p>
                            <p style="margin: 0; line-height: 1.6; color: #333;">
                                Instead of hardcoded workflows, AUTOPS employs a metadata-driven approach where tools are defined in JSON and dynamically loaded. 
                                This allows the system to adapt to any task type and easily integrate new capabilities.
                            </p>
                        </div>

                        <!-- Architecture Diagram -->
                        <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px 0; color: var(--tum-dark); font-size: 18px;">System Architecture</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 13px; overflow-x: auto;">
<pre style="margin: 0; line-height: 1.6;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     NATURAL LANGUAGE QUERY                  â”‚
â”‚              "How many ships in Taiwan Strait?"             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ITERATIVE REASONING ENGINE                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  THINK   â”‚â†’ â”‚   PLAN   â”‚â†’ â”‚ EXECUTE  â”‚â†’ â”‚ REFLECT  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â†“             â†“             â†“             â†“          â”‚
â”‚   Analyze      Create Plan    Run Tools    Evaluate &     â”‚
â”‚   Task &        with Tools    Dynamically  Continue?      â”‚
â”‚   Discover                                                 â”‚
â”‚   Tools                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GENERAL LLM  â”‚         â”‚ REASONING LLM â”‚
â”‚ llama3.1:8b   â”‚         â”‚deepseek-r1:70bâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                         â”‚
    Quick Tasks             Complex Reasoning
    (categorize,            (planning,
     discover)               reflection)
        â”‚                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   TOOL REGISTRY                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  tools_metadata.json  â†’  Dynamic Tool Loading        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Region Mapper  â”‚  â”‚Image Processor â”‚  â”‚   Object    â”‚  â”‚
â”‚  â”‚     Tool       â”‚  â”‚      Tool      â”‚  â”‚  Detector   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚  Data Fusion   â”‚        (More tools can be added       â”‚
â”‚  â”‚      Tool      â”‚         via JSON metadata)            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 SYNTHESIZED RESULT                          â”‚
â”‚        With confidence scoring and reasoning trace          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
                            </div>
                        </div>

                        <!-- Dual LLM Architecture -->
                        <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px 0; color: var(--tum-dark); font-size: 18px;">Dual LLM Strategy</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div style="padding: 15px; background: #e3f2fd; border-left: 4px solid var(--tum-blue); border-radius: 4px;">
                                    <h4 style="margin: 0 0 8px 0; color: var(--tum-blue); font-size: 14px;">General LLM</h4>
                                    <p style="margin: 0 0 8px 0; font-weight: 600;">llama3.1:8b</p>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.6;">
                                        <li>Task categorization</li>
                                        <li>Tool discovery</li>
                                        <li>Quick analysis</li>
                                        <li>Lower computational cost</li>
                                    </ul>
                                </div>
                                <div style="padding: 15px; background: #f3e5f5; border-left: 4px solid #7b1fa2; border-radius: 4px;">
                                    <h4 style="margin: 0 0 8px 0; color: #7b1fa2; font-size: 14px;">Reasoning LLM</h4>
                                    <p style="margin: 0 0 8px 0; font-weight: 600;">deepseek-r1:70b</p>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.6;">
                                        <li>Complex reasoning</li>
                                        <li>Execution planning</li>
                                        <li>Result reflection</li>
                                        <li>Includes thinking traces</li>
                                    </ul>
                                </div>
                            </div>
                            <p style="margin: 15px 0 0 0; font-size: 13px; color: #666; font-style: italic;">
                                Automatic fallback: Ollama (local, free) â†’ OpenAI (if unavailable)
                            </p>
                        </div>

                        <!-- Implemented Tools -->
                        <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px 0; color: var(--tum-dark); font-size: 18px;">Available Tools (EO Focus)</h3>
                            <div style="display: grid; gap: 15px;">
                                <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <span style="font-size: 20px; margin-right: 10px;">ğŸ—ºï¸</span>
                                        <h4 style="margin: 0; color: var(--tum-dark); font-size: 15px;">Region Mapper Tool</h4>
                                    </div>
                                    <p style="margin: 0 0 5px 0; font-size: 13px; color: #666;">Maps natural language region descriptions to geographical coordinates (lat, lon, bbox)</p>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span style="background: #e3f2fd; color: var(--tum-blue); padding: 3px 8px; border-radius: 3px; font-size: 11px;">geospatial</span>
                                        <span style="background: #e3f2fd; color: var(--tum-blue); padding: 3px 8px; border-radius: 3px; font-size: 11px;">mapping</span>
                                        <span style="background: #fff3e0; color: #f57c00; padding: 3px 8px; border-radius: 3px; font-size: 11px;">stub</span>
                                    </div>
                                </div>

                                <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <span style="font-size: 20px; margin-right: 10px;">ğŸ–¼ï¸</span>
                                        <h4 style="margin: 0; color: var(--tum-dark); font-size: 15px;">Image Processing Tool</h4>
                                    </div>
                                    <p style="margin: 0 0 5px 0; font-size: 13px; color: #666;">Performs image enhancement, resizing, and format conversion on satellite imagery</p>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span style="background: #e3f2fd; color: var(--tum-blue); padding: 3px 8px; border-radius: 3px; font-size: 11px;">image_analysis</span>
                                        <span style="background: #e3f2fd; color: var(--tum-blue); padding: 3px 8px; border-radius: 3px; font-size: 11px;">preprocessing</span>
                                        <span style="background: #fff3e0; color: #f57c00; padding: 3px 8px; border-radius: 3px; font-size: 11px;">stub</span>
                                    </div>
                                </div>

                                <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <span style="font-size: 20px; margin-right: 10px;">ğŸ¯</span>
                                        <h4 style="margin: 0; color: var(--tum-dark); font-size: 15px;">Object Detection Tool</h4>
                                    </div>
                                    <p style="margin: 0 0 5px 0; font-size: 13px; color: #666;">Detects and counts specific objects (ships, vehicles, fires) in satellite imagery using computer vision</p>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span style="background: #e3f2fd; color: var(--tum-blue); padding: 3px 8px; border-radius: 3px; font-size: 11px;">computer_vision</span>
                                        <span style="background: #e3f2fd; color: var(--tum-blue); padding: 3px 8px; border-radius: 3px; font-size: 11px;">detection</span>
                                        <span style="background: #e3f2fd; color: var(--tum-blue); padding: 3px 8px; border-radius: 3px; font-size: 11px;">earth_observation</span>
                                        <span style="background: #fff3e0; color: #f57c00; padding: 3px 8px; border-radius: 3px; font-size: 11px;">stub</span>
                                    </div>
                                </div>

                                <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <span style="font-size: 20px; margin-right: 10px;">ğŸ”—</span>
                                        <h4 style="margin: 0; color: var(--tum-dark); font-size: 15px;">Data Fusion Tool</h4>
                                    </div>
                                    <p style="margin: 0 0 5px 0; font-size: 13px; color: #666;">Fuses data from multiple sources or tools to provide consolidated, higher-level insights</p>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span style="background: #e3f2fd; color: var(--tum-blue); padding: 3px 8px; border-radius: 3px; font-size: 11px;">data_analysis</span>
                                        <span style="background: #e3f2fd; color: var(--tum-blue); padding: 3px 8px; border-radius: 3px; font-size: 11px;">synthesis</span>
                                        <span style="background: #fff3e0; color: #f57c00; padding: 3px 8px; border-radius: 3px; font-size: 11px;">stub</span>
                                    </div>
                                </div>
                            </div>
                            <p style="margin: 15px 0 0 0; padding: 12px; background: #fff3e0; border-left: 4px solid #f57c00; border-radius: 4px; font-size: 13px; color: #333;">
                                <strong>Note:</strong> All tools currently return mock data. Real implementations with satellite imagery, computer vision models, and geospatial processing will be integrated in future iterations.
                            </p>
                        </div>

                        <!-- How It Works -->
                        <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px 0; color: var(--tum-dark); font-size: 18px;">How It Works: Example Query</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 6px;">
                                <div style="margin-bottom: 20px;">
                                    <div style="background: var(--tum-blue); color: white; padding: 10px 15px; border-radius: 4px; font-weight: 500; margin-bottom: 10px;">
                                        User Query: "How many ships are in the Taiwan Strait?"
                                    </div>
                                </div>
                                
                                <div style="display: flex; flex-direction: column; gap: 12px; margin-left: 20px;">
                                    <div style="display: flex; gap: 12px; align-items: flex-start;">
                                        <div style="min-width: 30px; height: 30px; background: #e3f2fd; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--tum-blue);">1</div>
                                        <div style="flex: 1;">
                                            <strong style="color: var(--tum-dark);">THINK Phase</strong>
                                            <p style="margin: 5px 0 0 0; font-size: 13px; color: #666;">General LLM analyzes query â†’ Discovers relevant tools: <code>region_mapper</code>, <code>object_detector</code>, <code>data_fusion</code></p>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 12px; align-items: flex-start;">
                                        <div style="min-width: 30px; height: 30px; background: #f3e5f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #7b1fa2;">2</div>
                                        <div style="flex: 1;">
                                            <strong style="color: var(--tum-dark);">PLAN Phase</strong>
                                            <p style="margin: 5px 0 0 0; font-size: 13px; color: #666;">Reasoning LLM creates execution plan: Map region â†’ Detect ships â†’ Fuse results</p>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 12px; align-items: flex-start;">
                                        <div style="min-width: 30px; height: 30px; background: #e8f5e9; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #2e7d32;">3</div>
                                        <div style="flex: 1;">
                                            <strong style="color: var(--tum-dark);">EXECUTE Phase</strong>
                                            <p style="margin: 5px 0 0 0; font-size: 13px; color: #666;">Dynamically runs tools from registry â†’ Collects results</p>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 12px; align-items: flex-start;">
                                        <div style="min-width: 30px; height: 30px; background: #fff3e0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #f57c00;">4</div>
                                        <div style="flex: 1;">
                                            <strong style="color: var(--tum-dark);">REFLECT Phase</strong>
                                            <p style="margin: 5px 0 0 0; font-size: 13px; color: #666;">Reasoning LLM evaluates results â†’ Decides if more iterations needed â†’ Synthesizes final answer with confidence score</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Technical Details -->
                        <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px 0; color: var(--tum-dark); font-size: 18px;">Technical Implementation</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <h4 style="margin: 0 0 10px 0; color: #666; font-size: 14px; font-weight: 600;">Backend</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8; color: #333;">
                                        <li>Python 3.11+ with Flask API</li>
                                        <li>UV package manager</li>
                                        <li>Ollama (local) / OpenAI (fallback)</li>
                                        <li>Async tool execution</li>
                                        <li>JSON-based tool metadata</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 style="margin: 0 0 10px 0; color: #666; font-size: 14px; font-weight: 600;">Architecture Patterns</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8; color: #333;">
                                        <li>Metadata-driven tool system</li>
                                        <li>Dynamic tool loading</li>
                                        <li>Iterative reasoning loop</li>
                                        <li>Confidence tracking (0.0-1.0)</li>
                                        <li>Real-time reasoning visualization</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer with Information -->
            <div class="footer">
                <div class="footer-content">
                    <div class="info-footer">
                        <div class="contact-label">Contact</div>
                        Clemente J. Juan Oliver<br>
                        clemente.juan@tum.de
                    </div>
                    <div class="footer-right">
                        This work was supported by the AUTOPS project, within the Bavarian Joint Research Program of the StMWi (BayVFP), funding number MRF-2307-0004
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Navigation functionality
        function initNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const contentSections = document.querySelectorAll('.content-section');
            
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const targetSection = item.getAttribute('data-section');
                    
                    // Remove active class from all nav items
                    navItems.forEach(nav => nav.classList.remove('active'));
                    // Add active class to clicked item
                    item.classList.add('active');
                    
                    // Hide all content sections
                    contentSections.forEach(section => section.classList.remove('active'));
                    // Show target section
                    document.getElementById(targetSection).classList.add('active');
                });
            });
        }

        // System status checking
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (response.ok) {
                    const statusText = `LLM: ${data.llm_status}`;
                    // Update both status displays if they exist
                    const mainStatus = document.getElementById('llm-status');
                    const sidebarStatus = document.getElementById('llm-status-sidebar');
                    if (mainStatus) mainStatus.textContent = statusText;
                    if (sidebarStatus) sidebarStatus.textContent = statusText;
                } else {
                    const errorText = 'LLM: Error';
                    const mainStatus = document.getElementById('llm-status');
                    const sidebarStatus = document.getElementById('llm-status-sidebar');
                    if (mainStatus) mainStatus.textContent = errorText;
                    if (sidebarStatus) sidebarStatus.textContent = errorText;
                }
            } catch (error) {
                const offlineText = 'LLM: OpenAI API';
                const mainStatus = document.getElementById('llm-status');
                const sidebarStatus = document.getElementById('llm-status-sidebar');
                if (mainStatus) mainStatus.textContent = offlineText;
                if (sidebarStatus) sidebarStatus.textContent = offlineText;
            }
        }

        let currentTaskId = null;

        async function submitQuery() {
            currentTaskId = 'query-submission';
            
            // Update UI
            updateTaskDetails('Processing Query', 'In Progress');
            showReasoningTimeline();
            clearTimeline();
            
            // Clear previous results
            const container = document.getElementById('task-results');
            const content = document.getElementById('results-content');
            if (content) content.innerHTML = '';
            if (container) container.style.display = 'none';
            
            try {
                const query = (document.getElementById('task-input').value || '').trim();
                const additionalContext = (document.getElementById('additional-context-input').value || '').trim();
                
                if (!query) {
                    addTimelineItem('error', 'Validation Error', 'Please enter a query');
                    addLog('ERROR', 'Query validation failed', 'Query field is empty');
                    return;
                }
                
                addLog('INFO', 'Query submitted', `Task: ${query}`);
                if (additionalContext) {
                    addLog('INFO', 'Additional context', additionalContext);
                }
                addTimelineItem('reasoning', 'Submitting Query', `Query: ${query}`);
                
                const requestBody = { task: query };
                if (additionalContext) {
                    requestBody.additional_context = additionalContext;
                }
                
                // Use streaming endpoint for real-time updates
                const response = await fetch('/api/autonomous-tasking/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error('Query failed');
                }
                
                addLog('INFO', 'Processing reasoning (streaming)', 'Receiving real-time updates...');
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let finalResult = null;
                let iterations = 0;
                
                while (true) {
                    const {done, value} = await reader.read();
                    
                    if (done) {
                        break;
                    }
                    
                    buffer += decoder.decode(value, {stream: true});
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6);
                            try {
                                const event = JSON.parse(jsonStr);
                                
                                if (event.type === 'phase') {
                                    // Real-time phase update
                                    const stepType = event.step.includes('TOOL') || event.step.includes('EXECUTE') ? 'tool-call' : 'reasoning';
                                    const confidence = event.confidence && !isNaN(event.confidence) ? ` [Confidence: ${(event.confidence * 100).toFixed(0)}%]` : '';
                                    
                                    addEnhancedTimelineItem(event, stepType, confidence);
                                    addLog('DEBUG', 'Phase completed', event.step);
                                    
                                } else if (event.type === 'complete') {
                                    finalResult = event.result;
                                    iterations = event.iterations;
                                    
                                } else if (event.type === 'error') {
                                    throw new Error(event.error);
                                }
                            } catch (e) {
                                console.error('Failed to parse SSE event:', e);
                            }
                        }
                    }
                }
                
                if (!finalResult) {
                    throw new Error('No result received from server');
                }
                
                const data = finalResult;
                
                // Check if user input is required
                if (data.user_input_required && data.user_prompts && data.user_prompts.length > 0) {
                    // Show user input required in timeline
                    addTimelineItem('error', 'ğŸ”´ User Input Required', 
                        `System needs clarification: ${data.user_prompts.length} item(s) require attention`);
                    addLog('WARNING', 'Execution paused', 'User input required to continue');
                } else {
                    // Show completion
                    addTimelineItem('completed', 'Query Complete', 
                        `Completed in ${iterations} iteration(s)`);
                    addLog('INFO', 'Query completed successfully', `${iterations} iteration(s), confidence: ${(data.confidence * 100).toFixed(0)}%`);
                }
                
                // Log final results
                if (!data.user_input_required) {
                    addLog('INFO', 'âœ… Final Result', data.result || data.situation_summary || 'No result provided');
                    if (data.analysis) addLog('DEBUG', 'Analysis', data.analysis);
                    if (data.recommendations && data.recommendations.length > 0) {
                        addLog('DEBUG', 'Recommendations', data.recommendations.join('; '));
                    }
                } else {
                    // Log user input requirements
                    data.user_prompts.forEach(prompt => {
                        addLog('WARNING', `Input needed for ${prompt.tool || 'tool'}`, prompt.message);
                    });
                }
                
                // Display results
                displayQueryResults(data);
                
                if (data.user_input_required) {
                    updateTaskDetails('âš ï¸ User Input Required', 'Awaiting Clarification');
                } else {
                    updateTaskDetails('Query Complete', 'Completed');
                }
                
                displayInResultsSection(data, 'query');
                
            } catch (error) {
                console.error('Query error:', error);
                addLog('ERROR', 'Query execution failed', error.message);
                addLog('ERROR', 'Error Stack', error.stack || 'No stack trace available');
                addTimelineItem('error', 'Query Error', `Error: ${error.message}`);
                updateTaskDetails('Query', 'Error');
            }
        }
        
        function displayQueryResults(data) {
            const container = document.getElementById('task-results');
            const content = document.getElementById('results-content');
            
            // Check if user input is required
            if (data.user_input_required && data.user_prompts && data.user_prompts.length > 0) {
                displayUserInputRequest(data, content, container);
                return;
            }
            
            const result = data.result || data.situation_summary || '';
            const analysis = data.analysis || '';
            const recommendations = data.recommendations || [];
            const confidence = data.confidence || 0;
            
            content.innerHTML = `
                <div class="result-item"><span class="result-label">Query:</span> <span class="result-value">${data.query || data.task || ''}</span></div>
                <div class="result-item"><span class="result-label">Result:</span> <span class="result-value">${result}</span></div>
                <div class="result-item"><span class="result-label">Analysis:</span> <span class="result-value">${analysis}</span></div>
                <div class="result-item"><span class="result-label">Confidence:</span> <span class="result-value">${Math.round(confidence * 100)}%</span></div>
                ${recommendations.length > 0 ? `<div class="result-item"><span class="result-label">Recommendations:</span> <ul>${recommendations.map(r => `<li>${r}</li>`).join('')}</ul></div>` : ''}
            `;
            container.style.display = 'block';
        }
        
        function displayUserInputRequest(data, content, container) {
            addLog('WARNING', 'User input required', 'System needs clarification to proceed');
            
            const prompts = data.user_prompts.map((req, idx) => {
                const toolName = req.tool ? req.tool.split('_step_')[0] : 'Unknown Tool';
                return `
                    <div style="margin-bottom: 20px; padding: 20px; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 6px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">âš ï¸</span>
                            <h4 style="margin: 0; color: #e65100; font-size: 16px;">Input Required: ${toolName}</h4>
                        </div>
                        <div style="margin-bottom: 15px; color: #666; font-size: 14px; line-height: 1.6;">
                            ${req.message}
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 4px; border: 1px solid #ffcc80;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 8px; font-size: 13px;">What information is needed:</div>
                            <div style="white-space: pre-wrap; color: #555; font-size: 13px; line-height: 1.8;">${req.prompt}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            content.innerHTML = `
                <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 25px; border-radius: 8px; border: 2px solid #ff9800; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div style="width: 50px; height: 50px; background: #ff9800; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px;">
                            ğŸ”´
                        </div>
                        <div>
                            <h3 style="margin: 0; color: #e65100; font-size: 20px;">System Requires Additional Information</h3>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Please provide the missing details below to continue</p>
                        </div>
                    </div>
                </div>
                
                ${prompts}
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-top: 25px;">
                    <h4 style="margin: 0 0 12px 0; color: var(--tum-dark);">Provide Missing Information</h4>
                    <textarea id="user-clarification-input" 
                              style="width: calc(100% - 24px); min-height: 100px; padding: 12px; border: 2px solid #ff9800; border-radius: 4px; font-family: inherit; resize: vertical; font-size: 14px;"
                              placeholder="Enter the missing information here (e.g., 'Taiwan Strait' or coordinates [25.0, 121.5])"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 12px;">
                        <button onclick="resubmitWithClarification('${(data.query || data.task || '').replace(/'/g, "\\'")}', '${(data.additional_context || '').replace(/'/g, "\\'")}')" 
                                style="background: #ff9800; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600;">
                            âœ“ Submit Clarification
                        </button>
                        <button onclick="clearResults()" 
                                style="background: #bdc3c7; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            Cancel
                        </button>
                    </div>
                </div>
                
                <details style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <summary style="cursor: pointer; font-weight: 600; color: var(--tum-dark); font-size: 14px;">View Full Response</summary>
                    <pre style="margin-top: 10px; font-size: 11px; color: #666; white-space: pre-wrap; word-wrap: break-word;">${JSON.stringify(data, null, 2)}</pre>
                </details>
            `;
            
            container.style.display = 'block';
        }
        
        async function resubmitWithClarification(originalQuery, originalContext) {
            const clarification = document.getElementById('user-clarification-input')?.value.trim();
            
            if (!clarification) {
                alert('Please provide the missing information before submitting');
                return;
            }
            
            addLog('INFO', 'User provided clarification', clarification);
            
            // Combine original context with clarification
            const enhancedContext = originalContext 
                ? `${originalContext}. Additional clarification: ${clarification}` 
                : `Additional clarification: ${clarification}`;
            
            // Update the input fields
            document.getElementById('task-input').value = originalQuery;
            document.getElementById('additional-context-input').value = enhancedContext;
            
            // Resubmit the query
            await submitQuery();
        }

        async function executeAutonomousTasking() {
            currentTaskId = 'autonomous-tasking';
            updateTaskDetails('Autonomous Tasking', 'In Progress');
            showReasoningTimeline();
            clearTimeline();
            
            const container = document.getElementById('task-results');
            const content = document.getElementById('results-content');
            if (content) content.innerHTML = '';
            if (container) container.style.display = 'none';
            try {
                const task = (document.getElementById('task-input').value || '').trim();
                const additionalContext = (document.getElementById('additional-context-input').value || '').trim();
                
                addTimelineItem('reasoning', 'Processing Task', 'Using LLM to analyze and execute task...');
                
                const requestBody = { task };
                if (additionalContext) {
                    requestBody.additional_context = additionalContext;
                }
                
                const response = await fetch('/api/autonomous-tasking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Tasking failed');
                }
                
                const reasoningLog = data.reasoning_log || [];
                
                for (let i = 0; i < reasoningLog.length; i++) {
                    const step = reasoningLog[i];
                    const stepType = step.step.includes('TOOL') ? 'tool-call' : 'reasoning';
                    const confidence = step.confidence && !isNaN(step.confidence) ? ` [Confidence: ${(step.confidence * 100).toFixed(0)}%]` : '';
                    
                    addEnhancedTimelineItem(step, stepType, confidence);
                }
                
                const iterations = data.total_iterations || 1;
                addTimelineItem('completed', 'Reasoning Complete', 
                    `Completed in ${iterations} iteration(s) with ${reasoningLog.length} total steps`);
                
                // Display the final results
                displayAutonomousTaskingResults(data);
                updateTaskDetails('Autonomous Tasking', 'Completed');
                
                // Also display in Results section
                displayInResultsSection(data, 'autonomous_tasking');
                
            } catch (error) {
                addTimelineItem('error', 'Tasking Error', `Error: ${error.message}`);
                updateTaskDetails('Autonomous Tasking', 'Error');
            }
        }

        function displayAutonomousTaskingResults(data) {
            const container = document.getElementById('task-results');
            const content = document.getElementById('results-content');
            const shipCount = data.ship_count ?? (data.data_fusion_result && data.data_fusion_result.ship_count);
            const confidence = data.confidence ?? (data.data_fusion_result && data.data_fusion_result.confidence);
            const summaryImage = data.summary_image ?? (data.data_fusion_result && data.data_fusion_result.summary_image);
            const sats = data.assigned_satellites || [];
            const sensors = data.activated_sensors || [];
            const reasoningItems = (data.reasoning_log || []).map(r => `
                <div class="reasoning-item">
                    <div class="reasoning-meta"><span>${r.step}</span> â€¢ <span>${r.model || 'LLM'}</span></div>
                    <div class="reasoning-text">${r.summary || ''}</div>
                </div>
            `).join('');
            const messageItems = (data.messages || []).map(m => {
                const content = typeof m === 'string' ? m : (m.content || '');
                const step = typeof m === 'object' ? (m.step || '') : '';
                const confidence = typeof m === 'object' && m.confidence && !isNaN(m.confidence) ? ` [${(m.confidence * 100).toFixed(0)}%]` : '';
                return `
                    <div class="message-item">
                        ${step ? `<div class="message-header">${step}${confidence}</div>` : ''}
                        <pre class="model-message">${content.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre>
                    </div>
                `;
            }).join('');

            content.innerHTML = `
                <div class="result-item"><span class="result-label">Task:</span> <span class="result-value">${data.task || 'â€”'}</span></div>
                <div class="result-item"><span class="result-label">Assigned Satellites:</span> <span class="result-value">${sats.join(', ') || 'â€”'}</span></div>
                <div class="result-item"><span class="result-label">Activated Sensors:</span> <span class="result-value">${sensors.join(', ') || 'â€”'}</span></div>
                <div class="result-item"><span class="result-label">Ship Count:</span> <span class="result-value">${shipCount ?? 'â€”'}</span></div>
                <div class="result-item"><span class="result-label">Confidence:</span> <span class="result-value">${confidence ?? 'â€”'}</span></div>
                <div class="result-item"><span class="result-label">Report Time:</span> <span class="result-value">${data.report_time || 'â€”'}</span></div>
                ${summaryImage ? `<div class="result-item"><span class="result-label">Summary Image:</span> <span class="result-value">${summaryImage}</span></div>` : ''}
                ${reasoningItems ? `<details class="reasoning-log"><summary>Reasoning Log</summary>${reasoningItems}</details>` : ''}
                ${messageItems ? `<details class="messages-log"><summary>Model Messages</summary>${messageItems}</details>` : ''}
            `;
            container.style.display = 'block';
        }

        async function loadConstellationStatus() {
            try {
                const el = document.getElementById('constellation-status');
                if (!el) return;
                el.textContent = 'Loading constellation info...';
                const res = await fetch('/api/constellation/status');
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Status error');
                const satCount = data.available_satellites ? Object.keys(data.available_satellites).length : 0;
                el.innerHTML = `
                    Status: ${data.status || 'â€”'}<br>
                    Available Satellites: ${satCount}<br>
                    Active Assignments: ${data.active_assignments || 0}
                `;
            } catch (e) {
                const el = document.getElementById('constellation-status');
                if (el) el.textContent = `Error: ${e.message}`;
            }
        }

        function updateTaskDetails(title, status) {
            document.getElementById('selected-task-title').textContent = title;
            document.getElementById('selected-task-status').textContent = status;
        }

        function showReasoningTimeline() {
            document.getElementById('reasoning-timeline').style.display = 'block';
        }

        function clearTimeline() {
            document.getElementById('timeline-items').innerHTML = '';
        }

        function addEnhancedTimelineItem(step, stepType, confidenceText) {
            const container = document.getElementById('timeline-items');
            const time = new Date().toLocaleTimeString();
            
            let detailsHTML = '';
            
            // Extract phase-specific details
            if (step.step.includes('THINK')) {
                const details = [];
                if (step.task_understanding) details.push(`<strong>Task Understanding:</strong> ${step.task_understanding}`);
                if (step.relevant_tools && step.relevant_tools.length > 0) {
                    details.push(`<strong>Relevant Tools:</strong> ${step.relevant_tools.join(', ')}`);
                }
                if (step.problem_analysis) details.push(`<strong>Problem Analysis:</strong> ${step.problem_analysis}`);
                if (step.risk_assessment) details.push(`<strong>Risk Assessment:</strong> ${step.risk_assessment}`);
                if (step.information_needs && step.information_needs.length > 0) {
                    details.push(`<strong>Information Needs:</strong> ${step.information_needs.join(', ')}`);
                }
                if (step.constraints && step.constraints.length > 0) {
                    details.push(`<strong>Constraints:</strong> ${step.constraints.join(', ')}`);
                }
                if (details.length > 0) {
                    detailsHTML = `<details style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                        <summary style="cursor: pointer; font-weight: 600; color: var(--tum-blue);">View Details</summary>
                        <div style="margin-top: 10px; font-size: 13px; line-height: 1.6;">${details.join('<br><br>')}</div>
                    </details>`;
                }
            } else if (step.step.includes('PLAN')) {
                const details = [];
                if (step.execution_plan && step.execution_plan.length > 0) {
                    const planSteps = step.execution_plan.map((s, idx) => 
                        `${idx + 1}. <strong>${s.action || 'unknown'}</strong>: ${s.reason || 'no reason'}`
                    ).join('<br>');
                    details.push(`<strong>Execution Plan:</strong><br>${planSteps}`);
                }
                if (step.expected_outcomes) details.push(`<strong>Expected Outcomes:</strong> ${step.expected_outcomes}`);
                if (step.success_criteria) details.push(`<strong>Success Criteria:</strong> ${step.success_criteria}`);
                if (details.length > 0) {
                    detailsHTML = `<details style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                        <summary style="cursor: pointer; font-weight: 600; color: var(--tum-blue);">View Execution Plan</summary>
                        <div style="margin-top: 10px; font-size: 13px; line-height: 1.6;">${details.join('<br><br>')}</div>
                    </details>`;
                }
            } else if (step.step.includes('EXECUTE')) {
                const details = [];
                if (step.tool_results) {
                    const results = Object.entries(step.tool_results).map(([tool, result]) => {
                        const status = result.status || (result.error ? 'error' : 'success');
                        const statusColor = status === 'success' ? '#27ae60' : 
                                          status === 'not_implemented' ? '#f39c12' : '#e74c3c';
                        return `<div style="margin-bottom: 8px;">
                            <strong>${tool}:</strong> <span style="color: ${statusColor};">${status}</span>
                            ${result.error ? `<br><span style="color: #666; font-size: 12px;">Error: ${result.error}</span>` : ''}
                        </div>`;
                    }).join('');
                    details.push(`<strong>Tool Results:</strong><br>${results}`);
                }
                if (step.execution_summary) details.push(`<strong>Summary:</strong> ${step.execution_summary}`);
                if (details.length > 0) {
                    detailsHTML = `<details style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                        <summary style="cursor: pointer; font-weight: 600; color: var(--tum-blue);">View Tool Results</summary>
                        <div style="margin-top: 10px; font-size: 13px; line-height: 1.6;">${details.join('<br><br>')}</div>
                    </details>`;
                }
            } else if (step.step.includes('REFLECT')) {
                const details = [];
                if (step.goal_achievement) details.push(`<strong>Goal Achievement:</strong> ${step.goal_achievement}`);
                if (step.new_insights && step.new_insights.length > 0) {
                    details.push(`<strong>New Insights:</strong><ul style="margin: 5px 0; padding-left: 20px;">${step.new_insights.map(i => `<li>${i}</li>`).join('')}</ul>`);
                }
                if (step.gaps_identified && step.gaps_identified.length > 0) {
                    details.push(`<strong>Gaps Identified:</strong><ul style="margin: 5px 0; padding-left: 20px;">${step.gaps_identified.map(g => `<li>${g}</li>`).join('')}</ul>`);
                }
                if (step.blocking_factors && step.blocking_factors.length > 0) {
                    details.push(`<strong>Blocking Factors:</strong><ul style="margin: 5px 0; padding-left: 20px; color: #e74c3c;">${step.blocking_factors.map(b => `<li>${b}</li>`).join('')}</ul>`);
                }
                if (step.task_status) {
                    const statusColor = step.task_status === 'completed' ? '#27ae60' : 
                                      step.task_status === 'pending' ? '#f39c12' : 
                                      step.task_status === 'blocked' ? '#e74c3c' : '#666';
                    details.push(`<strong>Task Status:</strong> <span style="color: ${statusColor}; font-weight: 600;">${step.task_status}</span>`);
                }
                if (step.should_continue !== undefined) {
                    details.push(`<strong>Continue Reasoning:</strong> ${step.should_continue ? 'Yes' : 'No'}`);
                }
                if (step.recommendation) details.push(`<strong>Recommendation:</strong> ${step.recommendation}`);
                if (details.length > 0) {
                    detailsHTML = `<details style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                        <summary style="cursor: pointer; font-weight: 600; color: var(--tum-blue);">View Reflection</summary>
                        <div style="margin-top: 10px; font-size: 13px; line-height: 1.6;">${details.join('<br><br>')}</div>
                    </details>`;
                }
            }
            
            const timelineItem = document.createElement('div');
            timelineItem.className = `timeline-item ${stepType}`;
            timelineItem.innerHTML = `
                <div class="timeline-header">
                    <div class="timeline-type">${step.step}</div>
                    <div class="timeline-time">${time}</div>
                </div>
                <div class="timeline-content">
                    ${step.summary}${confidenceText}
                    ${detailsHTML}
                </div>
            `;
            
            container.appendChild(timelineItem);
            container.scrollTop = container.scrollHeight;
        }

        function addTimelineItem(type, title, content) {
            const container = document.getElementById('timeline-items');
            const time = new Date().toLocaleTimeString();
            
            const timelineItem = document.createElement('div');
            timelineItem.className = `timeline-item ${type}`;
            timelineItem.innerHTML = `
                <div class="timeline-header">
                    <div class="timeline-type">${title}</div>
                    <div class="timeline-time">${time}</div>
                </div>
                <div class="timeline-content">${content}</div>
            `;
            
            container.appendChild(timelineItem);
            container.scrollTop = container.scrollHeight;
        }

        function addToolCall(functionName, parameters) {
            const container = document.getElementById('timeline-items');
            const time = new Date().toLocaleTimeString();
            
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item tool-call';
            timelineItem.innerHTML = `
                <div class="timeline-header">
                    <div class="timeline-type">Tool Call</div>
                    <div class="timeline-time">${time}</div>
                </div>
                <div class="tool-call-code">${functionName}(${JSON.stringify(parameters, null, 2)})</div>
            `;
            
            container.appendChild(timelineItem);
            container.scrollTop = container.scrollHeight;
        }

        // History functionality
        let currentHistoryFilter = '';
        
        async function loadTaskHistory() {
            try {
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '<div class="loading-message">Loading task history...</div>';
                
                const response = await fetch('/api/task-history?limit=20');
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayTaskHistory(data.tasks);
                    updateHistoryStats(data.tasks);
                } else {
                    historyList.innerHTML = '<div class="loading-message">Error loading task history</div>';
                }
            } catch (error) {
                console.error('Error loading task history:', error);
                document.getElementById('historyList').innerHTML = '<div class="loading-message">Error loading task history</div>';
            }
        }
        
        function displayTaskHistory(tasks) {
            const historyList = document.getElementById('historyList');
            
            if (tasks.length === 0) {
                historyList.innerHTML = '<div class="loading-message">No task history available</div>';
                return;
            }
            
            const filteredTasks = currentHistoryFilter ? 
                tasks.filter(task => task.situation_type === currentHistoryFilter) : 
                tasks;
            
            historyList.innerHTML = filteredTasks.map(task => {
                const confidence = task.confidence && !isNaN(task.confidence) ? Math.round(task.confidence * 100) : 0;
                const confidenceClass = confidence >= 80 ? 'confidence-high' : 
                                      confidence >= 60 ? 'confidence-medium' : 'confidence-low';
                
                const timestamp = new Date(task.timestamp).toLocaleString();
                const summary = task.result?.situation_summary || task.result?.summary?.situation_summary || 'No summary available';
                
                let taskTitle = '';
                if (task.situation_type === 'collision_assessment') {
                    taskTitle = `Collision Assessment - ${task.satellite_id || 'Unknown Satellite'}`;
                } else if (task.situation_type === 'autonomous_tasking') {
                    const taskText = task.task_request?.task || 'Unknown Task';
                    taskTitle = `Autonomous Tasking - ${taskText.substring(0, 50)}${taskText.length > 50 ? '...' : ''}`;
                } else {
                    taskTitle = `Task #${task.id}`;
                }
                
                return `
                    <div class="history-item ${task.situation_type}">
                        <div class="history-header">
                            <h3 class="history-title">${taskTitle}</h3>
                            <div class="history-timestamp">${timestamp}</div>
                        </div>
                        <div class="history-meta">
                            <div class="history-meta-item">
                                <span>ğŸ“Š</span>
                                <span>ID: ${task.id}</span>
                            </div>
                            <div class="history-meta-item">
                                <span>ğŸ¯</span>
                                <span>Type: ${task.situation_type.replace('_', ' ')}</span>
                            </div>
                            <div class="history-meta-item">
                                <span>ğŸ“ˆ</span>
                                <span class="confidence-badge ${confidenceClass}">${confidence}%</span>
                            </div>
                            <div class="history-meta-item">
                                <span>âœ…</span>
                                <span>Status: ${task.status}</span>
                            </div>
                        </div>
                        <div class="history-summary">${summary}</div>
                        <div class="history-actions">
                            <button class="btn-small btn-view" onclick="viewTaskDetails(${task.id})">View Details</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateHistoryStats(tasks) {
            const totalTasks = tasks.length;
            const collisionTasks = tasks.filter(t => t.situation_type === 'collision_assessment').length;
            const taskingTasks = tasks.filter(t => t.situation_type === 'autonomous_tasking').length;
            const avgConfidence = tasks.length > 0 ? 
                Math.round(tasks.reduce((sum, t) => sum + (t.confidence && !isNaN(t.confidence) ? t.confidence : 0), 0) / tasks.length * 100) : 0;
            
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('collisionTasks').textContent = collisionTasks;
            document.getElementById('taskingTasks').textContent = taskingTasks;
            document.getElementById('avgConfidence').textContent = avgConfidence + '%';
        }
        
        function filterTaskHistory() {
            const filter = document.getElementById('historyFilter').value;
            currentHistoryFilter = filter;
            loadTaskHistory();
        }
        
        async function viewTaskDetails(taskId) {
            try {
                const response = await fetch(`/api/task-history/${taskId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    showTaskDetailsModal(data.task);
                } else {
                    alert('Error loading task details');
                }
            } catch (error) {
                console.error('Error loading task details:', error);
                alert('Error loading task details');
            }
        }
        
        function showTaskDetailsModal(task) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 8px; padding: 30px; max-width: 800px; 
                max-height: 80vh; overflow-y: auto; position: relative;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = 'Ã—';
            closeBtn.style.cssText = `
                position: absolute; top: 10px; right: 15px; background: none; border: none; 
                font-size: 24px; cursor: pointer; color: #666;
            `;
            closeBtn.onclick = () => document.body.removeChild(modal);
            
            const reasoningSteps = (task.reasoning_steps || []).map(step => `
                <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <strong>${step.state || 'Unknown'}</strong> (${step.confidence && !isNaN(step.confidence) ? Math.round(step.confidence * 100) : 0}%)
                    <div style="font-size: 14px; color: #666; margin-top: 5px;">${step.reasoning || step.message || 'No details'}</div>
                </div>
            `).join('');
            
            content.innerHTML = `
                ${closeBtn.outerHTML}
                <h2 style="margin-top: 0; color: var(--tum-dark);">Task Details #${task.id}</h2>
                <div style="margin-bottom: 20px;">
                    <strong>Type:</strong> ${task.situation_type.replace('_', ' ')}<br>
                    <strong>Timestamp:</strong> ${new Date(task.timestamp).toLocaleString()}<br>
                    <strong>Confidence:</strong> ${task.confidence && !isNaN(task.confidence) ? Math.round(task.confidence * 100) : 0}%<br>
                    <strong>Status:</strong> ${task.status}
                </div>
                <h3>Reasoning Steps:</h3>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${reasoningSteps || '<div style="color: #666;">No reasoning steps available</div>'}
                </div>
                <h3>Result Summary:</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    ${task.result?.situation_summary || task.result?.summary?.situation_summary || 'No summary available'}
                </div>
                <button onclick="document.body.removeChild(this.closest('div').parentElement)" 
                        style="background: var(--tum-blue); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                    Close
                </button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        async function clearTaskHistory() {
            if (confirm('Are you sure you want to clear all task history? This action cannot be undone.')) {
                try {
                    const response = await fetch('/api/task-history/clear', { method: 'POST' });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        loadTaskHistory();
                        alert('Task history cleared successfully');
                    } else {
                        alert('Error clearing task history');
                    }
                } catch (error) {
                    console.error('Error clearing task history:', error);
                    alert('Error clearing task history');
                }
            }
        }

        // Results section functions
        let currentResultsData = null;
        
        function displayInResultsSection(data, taskType) {
            currentResultsData = data;
            
            // Hide empty state, show content (if elements exist)
            const emptyEl = document.getElementById('results-empty');
            const contentEl = document.getElementById('results-content');
            if (emptyEl) emptyEl.style.display = 'none';
            if (contentEl) contentEl.style.display = 'block';
            
            // Update title (if elements exist)
            const titleEl = document.getElementById('results-title');
            const subtitleEl = document.getElementById('results-subtitle');
            if (titleEl) titleEl.textContent = data.task || 'Task Results';
            if (subtitleEl) subtitleEl.textContent = `Completed at ${new Date().toLocaleString()}`;
            
            // Display visualization
            const vizDiv = document.getElementById('results-visualization');
            if (!vizDiv) return; // Exit if results section doesn't exist
            if (data.annotated_image_base64) {
                vizDiv.innerHTML = `<img src="data:image/png;base64,${data.annotated_image_base64}" style="max-width: 100%; max-height: 600px; border-radius: 8px;" alt="Analysis visualization">`;
            } else {
                vizDiv.innerHTML = '<p style="color: #999;">No visualization data available for this task type</p>';
            }
            
            // Display metrics
            const metricsDiv = document.getElementById('results-metrics');
            const metrics = [];
            
            // Extract relevant metrics based on task type
            if (data.detections || data.annotated_image_base64) {
                // Earth Observation task
                metrics.push(
                    { label: 'Objects Detected', value: (data.detections?.length || 0).toString() },
                    { label: 'Confidence', value: `${Math.round((data.confidence || 0) * 100)}%` },
                    { label: 'Region', value: data.region || '-' },
                    { label: 'Status', value: data.status || 'completed' }
                );
            } else if (data.assigned_satellites) {
                // Constellation task
                metrics.push(
                    { label: 'Satellites Assigned', value: data.assigned_satellites.length.toString() },
                    { label: 'Sensors Activated', value: data.activated_sensors?.length.toString() || '0' },
                    { label: 'Confidence', value: `${Math.round((data.confidence || 0) * 100)}%` },
                    { label: 'Task Status', value: data.task_status || 'completed' }
                );
            } else {
                // Generic task
                metrics.push(
                    { label: 'Status', value: data.status || data.task_status || 'completed' },
                    { label: 'Confidence', value: `${Math.round((data.confidence || 0) * 100)}%` }
                );
            }
            
            metricsDiv.innerHTML = metrics.map(m => `
                <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid var(--tum-blue);">
                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 5px;">${m.label}</div>
                    <div style="font-size: 20px; font-weight: bold; color: var(--tum-dark);">${m.value}</div>
                </div>
            `).join('');
            
            // Display detailed results
            document.getElementById('results-details').textContent = JSON.stringify(data, null, 2);
            
            // Switch to Results tab
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector('[data-section="results"]').classList.add('active');
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            document.getElementById('results').classList.add('active');
        }
        
        function downloadResults() {
            if (!currentResultsData) {
                alert('No results available to download');
                return;
            }
            
            const dataStr = JSON.stringify(currentResultsData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `task_results_${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        function clearResults() {
            currentResultsData = null;
            const emptyEl = document.getElementById('results-empty');
            const contentEl = document.getElementById('results-content');
            if (emptyEl) emptyEl.style.display = 'block';
            if (contentEl) contentEl.style.display = 'none';
        }

        window.onload = function() {
            initNavigation();
            checkSystemStatus();
            loadConstellationStatus();
            setInterval(checkSystemStatus, 30000);
            setInterval(loadConstellationStatus, 60000);
            
            const historyNavItem = document.querySelector('[data-section="history"]');
            if (historyNavItem) {
                historyNavItem.addEventListener('click', loadTaskHistory);      
            }

            addLog('INFO', 'System initialized', 'AUTOPS ready for queries');
        };

        // Logging Functions
        let logEntries = [];
        let logCounts = { INFO: 0, WARNING: 0, ERROR: 0, DEBUG: 0 };

        function addLog(level, message, details = '') {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const entry = { level, message, details, timestamp, id: Date.now() };
            logEntries.push(entry);

            // Update counts
            if (logCounts[level] !== undefined) logCounts[level]++;
            updateLogStats();

            // Get color for level
            const colors = {
                'INFO': '#4caf50',
                'WARNING': '#ff9800',
                'ERROR': '#f44336',
                'DEBUG': '#2196f3'
            };

            // Create log entry HTML
            const logConsole = document.getElementById('logConsole');
            if (logEntries.length === 1) {
                logConsole.innerHTML = ''; // Clear placeholder
            }

            const logLine = document.createElement('div');
            logLine.className = `log-entry log-${level}`;
            logLine.setAttribute('data-level', level);
            logLine.style.marginBottom = '6px';
            logLine.style.padding = '4px 0';
            logLine.style.borderBottom = '1px solid #2d2d30';
            
            // Format details for better readability
            let formattedDetails = details;
            if (details) {
                // Convert to string if it's an object
                if (typeof details === 'object') {
                    formattedDetails = JSON.stringify(details, null, 2);
                } else if (typeof details === 'string' && (details.startsWith('{') || details.startsWith('['))) {
                    // It's a JSON string, make it more readable
                    try {
                        const parsed = JSON.parse(details);
                        formattedDetails = JSON.stringify(parsed, null, 2);
                    } catch (e) {
                        // Not valid JSON, keep as is
                    }
                }
            }
            
            logLine.innerHTML = `
                <span style="color: #858585;">[${timestamp}]</span>
                <span style="color: ${colors[level]}; font-weight: bold;">[${level}]</span>
                <span style="color: #d4d4d4;">${message}</span>
                ${formattedDetails ? `<pre style="color: #858585; margin: 4px 0 0 100px; font-size: 10px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace;">${formattedDetails}</pre>` : ''}
            `;

            logConsole.appendChild(logLine);

            // Auto-scroll if enabled
            if (document.getElementById('autoScrollLogs')?.checked) {
                logConsole.scrollTop = logConsole.scrollHeight;
            }

            // Update timestamp
            document.getElementById('logTimestamp').textContent = timestamp;
        }

        function updateLogStats() {
            document.getElementById('logCount').textContent = logEntries.length;
            document.getElementById('infoCount').textContent = logCounts.INFO;
            document.getElementById('warningCount').textContent = logCounts.WARNING;
            document.getElementById('errorCount').textContent = logCounts.ERROR;
        }

        function clearLogs() {
            if (confirm('Are you sure you want to clear all logs?')) {
                logEntries = [];
                logCounts = { INFO: 0, WARNING: 0, ERROR: 0, DEBUG: 0 };
                document.getElementById('logConsole').innerHTML = `
                    <div style="color: #858585; font-style: italic;">
                        System logs will appear here...<br>
                        <span style="font-size: 10px;">Detailed logs include: LLM responses, tool I/O, reasoning traces, confidence scores, and execution flow</span>
                    </div>
                `;
                updateLogStats();
                document.getElementById('logTimestamp').textContent = '--:--:--';
            }
        }

        function downloadLogs() {
            if (logEntries.length === 0) {
                alert('No UI logs available to download');
                return;
            }

            const logText = logEntries.map(entry => 
                `[${entry.timestamp}] [${entry.level}] ${entry.message}${entry.details ? '\n  ' + entry.details : ''}`
            ).join('\n');

            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `autops_ui_logs_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            addLog('INFO', 'UI logs downloaded', `${logEntries.length} entries exported`);
        }
        
        async function downloadBackendLogs() {
            try {
                addLog('INFO', 'Downloading backend logs', 'Fetching from server...');
                const response = await fetch('/api/logs/backend');
                
                if (!response.ok) {
                    throw new Error('Backend logs not available');
                }
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `autops_backend_${new Date().toISOString().replace(/[:.]/g, '-')}.log`;
                link.click();
                URL.revokeObjectURL(url);
                
                addLog('INFO', 'Backend logs downloaded', 'File saved successfully');
            } catch (error) {
                addLog('ERROR', 'Failed to download backend logs', error.message);
                alert('Failed to download backend logs: ' + error.message);
            }
        }
        
        async function clearBackendLogs() {
            if (!confirm('Are you sure you want to clear backend logs? This will delete the server-side log file.')) {
                return;
            }
            
            try {
                addLog('INFO', 'Clearing backend logs', 'Sending request to server...');
                const response = await fetch('/api/logs/backend/clear', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    addLog('INFO', 'Backend logs cleared', data.message);
                    alert('Backend logs cleared successfully');
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                addLog('ERROR', 'Failed to clear backend logs', error.message);
                alert('Failed to clear backend logs: ' + error.message);
            }
        }

        // Log filtering
        document.querySelectorAll('.log-filter').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const level = checkbox.getAttribute('data-level');
                const entries = document.querySelectorAll(`.log-${level}`);
                entries.forEach(entry => {
                    entry.style.display = checkbox.checked ? 'block' : 'none';
                });
            });
        });
    </script>
</body>
</html>